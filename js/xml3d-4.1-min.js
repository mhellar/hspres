var XML3D=XML3D||{};XML3D.version="4.1.1";XML3D.xml3dNS="http://www.xml3d.org/2009/xml3d";XML3D.xhtmlNS="http://www.w3.org/1999/xhtml";XML3D.webglNS="http://www.xml3d.org/2009/xml3d/webgl";XML3D._xml3d=document.createElementNS(XML3D.xml3dNS,"xml3d");XML3D._native=!!XML3D._xml3d.style;XML3D.extend=function(b,a){for(var c in a)if(void 0===a[c])delete b[c];else if("constructor"!==c||b!==window)b[c]=a[c];return b};
XML3D.createClass=function(b,a,c){c=c||{};if(a){var d=function(){};d.prototype=a.prototype;b.prototype=new d;b.prototype.constructor=b;b.superclass=a.prototype}for(var e in c)b.prototype[e]=c[e];return b};
(function(){var b=function(){if(XML3D.document)XML3D.document.onunload()};window.addEventListener("load",function(){var a=XML3D.debug.setup();a&&XML3D.debug.logInfo("xml3d.js version: "+XML3D.version);var b=document.getElementsByTagNameNS(XML3D.xml3dNS,"xml3d"),b=Array.map(b,function(a){return a});a&&XML3D.debug.logInfo("Found "+b.length+" xml3d nodes...");if(b.length&&XML3D._native)a&&XML3D.debug.logInfo("Using native implementation.");else if(!XML3D.webgl||!XML3D.webgl.supported()){a&&XML3D.debug.logWarning("Could not initialise WebGL, sorry :-(");
for(a=0;a<b.length;a++){var d=document.createElementNS(XML3D.xhtmlNS,"div"),e=b[a];e.parentNode.insertBefore(d,e);d.appendChild(e);d.style.display="none";var f=document.createElementNS(XML3D.xhtmlNS,"div");f.setAttribute("class",e.getAttribute("class"));f.setAttribute("style",e.getAttribute("style"));f.style.border="2px solid red";f.style.color="red";f.style.padding="10px";f.style.backgroundColor="rgba(255, 0, 0, 0.3)";var g=e.getAttribute("width");null!==g&&(f.style.width=g);e=e.getAttribute("height");
null!==e&&(f.style.height=e);e=document.createElement("h3");g=document.createTextNode("Your browser doesn't appear to support XML3D.");e.appendChild(g);g=document.createElement("p");g.appendChild(document.createTextNode("Please visit "));var h=document.createElement("a");h.setAttribute("href","http://www.xml3d.org");h.appendChild(document.createTextNode("http://www.xml3d.org"));g.appendChild(h);g.appendChild(document.createTextNode(" to get information about browsers supporting XML3D."));f.appendChild(e);
f.appendChild(g);d.parentNode.insertBefore(f,d)}}else{try{XML3D.config.configure(b)}catch(i){a&&XML3D.debug.logError("Error initalizing interfaces: "+i)}try{XML3D.webgl.configure(b)}catch(j){a&&XML3D.debug.logError("Error initalizing webgl: "+j)}(function(a){var b=null;document.createEvent?(b=document.createEvent("Events"),b.initEvent(a,!0,!0),document.dispatchEvent(b)):document.createEventObject&&(b=document.createEventObject(),document.fireEvent("on"+a,b))})("load")}},!1);window.addEventListener("unload",
b,!1);window.addEventListener("reload",b,!1)})();XML3D.util=XML3D.util||{};XML3D.util.getStyle=function(b,a){var c="";document.defaultView&&document.defaultView.getComputedStyle?c=document.defaultView.getComputedStyle(b,"").getPropertyValue(a):b.currentStyle&&(a=a.replace(/\-(\w)/g,function(a,b){return b.toUpperCase()}),c=b.currentStyle[a]);return c};
XML3D.setParameter=function(b,a,c){if(b=document.getElementById(b))for(var b=b.childNodes,d=0;d<b.length;d++){var e=b[d];if(e.nodeType===Node.ELEMENT_NODE&&e.name==a&&"string"===typeof c){for(;e.hasChildNodes();)e.removeChild(e.lastChild);e.appendChild(document.createTextNode(c));return!0}}return!1};
window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(b,a){window.setTimeout(b,1E3/a)}}();Array.forEach||(Array.forEach=function(b,a,c){for(var d=b.length,e=0;e<d;e++)e in b&&a.call(c,b[e],e,b)});Array.map||(Array.map=function(b,a,c){for(var d=b.length,e=[],f=0;f<d;f++)f in b&&(e[f]=a.call(c,b[f],f,b));return e});Array.filter||(Array.filter=function(b,a,c){for(var d=b.length,e=[],f=0;f<d;f++)if(f in b){var g=b[f];a.call(c,g,f,b)&&e.push(g)}return e});Array.isArray||(Array.isArray=function(b){return Object.prototype.toString.call(b)=="[object Array]"});XML3D.debug={ALL:0,DEBUG:1,INFO:2,WARNING:3,ERROR:4,EXCEPTION:5,params:{},isSetup:!1,loglevel:4,loglevels:{all:0,debug:1,info:2,warning:3,error:4,exception:5},setup:function(){var b=XML3D.debug;b.isSetup||(window.location.search.substr(1).split("&").forEach(function(a){a=a.split("=");b.params[a[0].toLowerCase()]=decodeURIComponent(a[1])}),b.loglevel=b.loglevels[b.params.xml3d_loglevel]||b.params.xml3d_loglevel||b.loglevels.error,XML3D.debug.isSetup=!0);return!XML3D.debug.params.xml3d_nolog},doLog:function(b,
a){if(!(XML3D.debug.params.xml3d_nolog||a<XML3D.debug.loglevel)&&window.console)switch(a){case XML3D.debug.INFO:window.console.info(b);break;case XML3D.debug.WARNING:window.console.warn(b);break;case XML3D.debug.ERROR:window.console.error(b);break;case XML3D.debug.EXCEPTION:window.console.debug(b);break;case XML3D.debug.DEBUG:window.console.debug(b)}},logDebug:function(b){XML3D.debug.doLog(b,XML3D.debug.DEBUG)},logInfo:function(b){XML3D.debug.doLog(b,XML3D.debug.INFO)},logWarning:function(b){XML3D.debug.doLog(b,
XML3D.debug.WARNING)},logError:function(b){XML3D.debug.doLog(b,XML3D.debug.ERROR)},logException:function(b){XML3D.debug.doLog(b,XML3D.debug.EXCEPTION)},assert:function(b,a){b||XML3D.debug.doLog("Assertion failed in "+XML3D.debug.assert.caller.name+": "+a,XML3D.debug.WARNING)}};XML3D.URI=function(b){b=(b||"").match(/^(?:([^:\/?\#]+):)?(?:\/\/([^\/?\#]*))?([^?\#]*)(?:\?([^\#]*))?(?:\#(.*))?/);this.valid=null!=b;this.scheme=b[1]||null;this.authority=b[2]||null;this.path=b[3]||null;this.query=b[4]||null;this.fragment=b[5]||null};XML3D.URI.prototype.toString=function(){var b="";this.scheme&&(b+=this.scheme+":");this.authority&&(b+="//"+this.authority);this.path&&(b+=this.path);this.query&&(b+="?"+this.query);this.fragment&&(b+="#"+this.fragment);return b};
XML3D.URIResolver=function(){};XML3D.URIResolver.resolve=function(b,a){"string"==typeof b&&(b=new XML3D.URI(b));a=a||window.document;if("urn"==b.scheme)return XML3D.debug.logInfo("++ Found URN."+b),null;if(!b.path&&b.fragment)return a.getElementById(b.fragment);XML3D.debug.logWarning("++ Can't resolve URI: "+b.toString());return null};var GLU={};
(function(b){b.unProject=function(a,c,d,e,f,g,h){a=[a,c,d,1];c=[];b.multMatrices(e,f,c);if(!b.invertMatrix(c,c))return!1;a[0]=(a[0]-g[0])/g[2];a[1]=(a[1]-g[1])/g[3];a[0]=2*a[0]-1;a[1]=2*a[1]-1;a[2]=2*a[2]-1;e=[];b.multMatrixVec(c,a,e);if(0===e[3])return!1;e[0]/=e[3];e[1]/=e[3];e[2]/=e[3];h[0]=e[0];h[1]=e[1];h[2]=e[2];return!0};b.multMatrixVec=function(a,b,d){for(var e=0;4>e;e+=1)d[e]=b[0]*a[0+e]+b[1]*a[4+e]+b[2]*a[8+e]+b[3]*a[12+e]};b.multMatrices=function(a,b,d){for(var e=0;4>e;e+=1)for(var f=0;4>
f;f+=1)d[4*e+f]=a[4*e+0]*b[0+f]+a[4*e+1]*b[4+f]+a[4*e+2]*b[8+f]+a[4*e+3]*b[12+f]};b.invertMatrix=function(a,b){var d=[];d[0]=a[5]*a[10]*a[15]-a[5]*a[11]*a[14]-a[9]*a[6]*a[15]+a[9]*a[7]*a[14]+a[13]*a[6]*a[11]-a[13]*a[7]*a[10];d[4]=-a[4]*a[10]*a[15]+a[4]*a[11]*a[14]+a[8]*a[6]*a[15]-a[8]*a[7]*a[14]-a[12]*a[6]*a[11]+a[12]*a[7]*a[10];d[8]=a[4]*a[9]*a[15]-a[4]*a[11]*a[13]-a[8]*a[5]*a[15]+a[8]*a[7]*a[13]+a[12]*a[5]*a[11]-a[12]*a[7]*a[9];d[12]=-a[4]*a[9]*a[14]+a[4]*a[10]*a[13]+a[8]*a[5]*a[14]-a[8]*a[6]*a[13]-
a[12]*a[5]*a[10]+a[12]*a[6]*a[9];d[1]=-a[1]*a[10]*a[15]+a[1]*a[11]*a[14]+a[9]*a[2]*a[15]-a[9]*a[3]*a[14]-a[13]*a[2]*a[11]+a[13]*a[3]*a[10];d[5]=a[0]*a[10]*a[15]-a[0]*a[11]*a[14]-a[8]*a[2]*a[15]+a[8]*a[3]*a[14]+a[12]*a[2]*a[11]-a[12]*a[3]*a[10];d[9]=-a[0]*a[9]*a[15]+a[0]*a[11]*a[13]+a[8]*a[1]*a[15]-a[8]*a[3]*a[13]-a[12]*a[1]*a[11]+a[12]*a[3]*a[9];d[13]=a[0]*a[9]*a[14]-a[0]*a[10]*a[13]-a[8]*a[1]*a[14]+a[8]*a[2]*a[13]+a[12]*a[1]*a[10]-a[12]*a[2]*a[9];d[2]=a[1]*a[6]*a[15]-a[1]*a[7]*a[14]-a[5]*a[2]*a[15]+
a[5]*a[3]*a[14]+a[13]*a[2]*a[7]-a[13]*a[3]*a[6];d[6]=-a[0]*a[6]*a[15]+a[0]*a[7]*a[14]+a[4]*a[2]*a[15]-a[4]*a[3]*a[14]-a[12]*a[2]*a[7]+a[12]*a[3]*a[6];d[10]=a[0]*a[5]*a[15]-a[0]*a[7]*a[13]-a[4]*a[1]*a[15]+a[4]*a[3]*a[13]+a[12]*a[1]*a[7]-a[12]*a[3]*a[5];d[14]=-a[0]*a[5]*a[14]+a[0]*a[6]*a[13]+a[4]*a[1]*a[14]-a[4]*a[2]*a[13]-a[12]*a[1]*a[6]+a[12]*a[2]*a[5];d[3]=-a[1]*a[6]*a[11]+a[1]*a[7]*a[10]+a[5]*a[2]*a[11]-a[5]*a[3]*a[10]-a[9]*a[2]*a[7]+a[9]*a[3]*a[6];d[7]=a[0]*a[6]*a[11]-a[0]*a[7]*a[10]-a[4]*a[2]*
a[11]+a[4]*a[3]*a[10]+a[8]*a[2]*a[7]-a[8]*a[3]*a[6];d[11]=-a[0]*a[5]*a[11]+a[0]*a[7]*a[9]+a[4]*a[1]*a[11]-a[4]*a[3]*a[9]-a[8]*a[1]*a[7]+a[8]*a[3]*a[5];d[15]=a[0]*a[5]*a[10]-a[0]*a[6]*a[9]-a[4]*a[1]*a[10]+a[4]*a[2]*a[9]+a[8]*a[1]*a[6]-a[8]*a[2]*a[5];var e=a[0]*d[0]+a[1]*d[4]+a[2]*d[8]+a[3]*d[12];if(0===e)return!1;for(var e=1/e,f=0;16>f;f+=1)b[f]=d[f]*e;return!0}})(GLU);var glMatrixArrayType;glMatrixArrayType="undefined"!=typeof Float32Array?Float32Array:Array;
var vec3={create:function(b){var a=new glMatrixArrayType(3);b&&(a[0]=b[0],a[1]=b[1],a[2]=b[2]);return a},set:function(b,a){a[0]=b[0];a[1]=b[1];a[2]=b[2];return a},add:function(b,a,c){if(!c||b==c)return b[0]+=a[0],b[1]+=a[1],b[2]+=a[2],b;c[0]=b[0]+a[0];c[1]=b[1]+a[1];c[2]=b[2]+a[2];return c},subtract:function(b,a,c){if(!c||b==c)return b[0]-=a[0],b[1]-=a[1],b[2]-=a[2],b;c[0]=b[0]-a[0];c[1]=b[1]-a[1];c[2]=b[2]-a[2];return c},negate:function(b,a){a||(a=b);a[0]=-b[0];a[1]=-b[1];a[2]=-b[2];return a},scale:function(b,
a,c){if(!c||b==c)return b[0]*=a,b[1]*=a,b[2]*=a,b;c[0]=b[0]*a;c[1]=b[1]*a;c[2]=b[2]*a;return c},normalize:function(b,a){a||(a=b);var c=b[0],d=b[1],e=b[2],f=Math.sqrt(c*c+d*d+e*e);if(!f)return a[0]=0,a[1]=0,a[2]=0,a;if(1==f)return a[0]=c,a[1]=d,a[2]=e,a;f=1/f;a[0]=c*f;a[1]=d*f;a[2]=e*f;return a},cross:function(b,a,c){c||(c=b);var d=b[0],e=b[1],b=b[2],f=a[0],g=a[1],a=a[2];c[0]=e*a-b*g;c[1]=b*f-d*a;c[2]=d*g-e*f;return c},length:function(b){var a=b[0],c=b[1],b=b[2];return Math.sqrt(a*a+c*c+b*b)},dot:function(b,
a){return b[0]*a[0]+b[1]*a[1]+b[2]*a[2]},direction:function(b,a,c){c||(c=b);var d=b[0]-a[0],e=b[1]-a[1],b=b[2]-a[2],a=Math.sqrt(d*d+e*e+b*b);if(!a)return c[0]=0,c[1]=0,c[2]=0,c;a=1/a;c[0]=d*a;c[1]=e*a;c[2]=b*a;return c},lerp:function(b,a,c,d){d||(d=b);d[0]=b[0]+c*(a[0]-b[0]);d[1]=b[1]+c*(a[1]-b[1]);d[2]=b[2]+c*(a[2]-b[2]);return d},str:function(b){return"["+b[0]+", "+b[1]+", "+b[2]+"]"}},mat3={create:function(b){var a=new glMatrixArrayType(9);b&&(a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],
a[5]=b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a[9]=b[9]);return a},set:function(b,a){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];a[4]=b[4];a[5]=b[5];a[6]=b[6];a[7]=b[7];a[8]=b[8];return a},identity:function(b){b[0]=1;b[1]=0;b[2]=0;b[3]=0;b[4]=1;b[5]=0;b[6]=0;b[7]=0;b[8]=1;return b},transpose:function(b,a){if(!a||b==a){var c=b[1],d=b[2],e=b[5];b[1]=b[3];b[2]=b[6];b[3]=c;b[5]=b[7];b[6]=d;b[7]=e;return b}a[0]=b[0];a[1]=b[3];a[2]=b[6];a[3]=b[1];a[4]=b[4];a[5]=b[7];a[6]=b[2];a[7]=b[5];a[8]=b[8];return a},toMat4:function(b,
a){a||(a=mat4.create());a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=0;a[4]=b[3];a[5]=b[4];a[6]=b[5];a[7]=0;a[8]=b[6];a[9]=b[7];a[10]=b[8];a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a},str:function(b){return"["+b[0]+", "+b[1]+", "+b[2]+", "+b[3]+", "+b[4]+", "+b[5]+", "+b[6]+", "+b[7]+", "+b[8]+"]"}},mat4={create:function(b){var a=new glMatrixArrayType(16);b&&(a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a[9]=b[9],a[10]=b[10],a[11]=b[11],a[12]=b[12],a[13]=b[13],
a[14]=b[14],a[15]=b[15]);return a},set:function(b,a){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];a[4]=b[4];a[5]=b[5];a[6]=b[6];a[7]=b[7];a[8]=b[8];a[9]=b[9];a[10]=b[10];a[11]=b[11];a[12]=b[12];a[13]=b[13];a[14]=b[14];a[15]=b[15];return a},identity:function(b){b[0]=1;b[1]=0;b[2]=0;b[3]=0;b[4]=0;b[5]=1;b[6]=0;b[7]=0;b[8]=0;b[9]=0;b[10]=1;b[11]=0;b[12]=0;b[13]=0;b[14]=0;b[15]=1;return b},transpose:function(b,a){if(!a||b==a){var c=b[1],d=b[2],e=b[3],f=b[6],g=b[7],h=b[11];b[1]=b[4];b[2]=b[8];b[3]=b[12];b[4]=
c;b[6]=b[9];b[7]=b[13];b[8]=d;b[9]=f;b[11]=b[14];b[12]=e;b[13]=g;b[14]=h;return b}a[0]=b[0];a[1]=b[4];a[2]=b[8];a[3]=b[12];a[4]=b[1];a[5]=b[5];a[6]=b[9];a[7]=b[13];a[8]=b[2];a[9]=b[6];a[10]=b[10];a[11]=b[14];a[12]=b[3];a[13]=b[7];a[14]=b[11];a[15]=b[15];return a},determinant:function(b){var a=b[0],c=b[1],d=b[2],e=b[3],f=b[4],g=b[5],h=b[6],i=b[7],j=b[8],k=b[9],m=b[10],o=b[11],l=b[12],n=b[13],p=b[14],b=b[15];return l*k*h*e-j*n*h*e-l*g*m*e+f*n*m*e+j*g*p*e-f*k*p*e-l*k*d*i+j*n*d*i+l*c*m*i-a*n*m*i-j*c*
p*i+a*k*p*i+l*g*d*o-f*n*d*o-l*c*h*o+a*n*h*o+f*c*p*o-a*g*p*o-j*g*d*b+f*k*d*b+j*c*h*b-a*k*h*b-f*c*m*b+a*g*m*b},inverse:function(b,a){a||(a=b);var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],m=b[9],o=b[10],l=b[11],n=b[12],p=b[13],r=b[14],v=b[15],u=c*h-d*g,t=c*i-e*g,x=c*j-f*g,s=d*i-e*h,q=d*j-f*h,y=e*j-f*i,z=k*p-m*n,A=k*r-o*n,B=k*v-l*n,C=m*r-o*p,D=m*v-l*p,E=o*v-l*r,w=1/(u*E-t*D+x*C+s*B-q*A+y*z);a[0]=(h*E-i*D+j*C)*w;a[1]=(-d*E+e*D-f*C)*w;a[2]=(p*y-r*q+v*s)*w;a[3]=(-m*y+o*q-l*s)*w;a[4]=
(-g*E+i*B-j*A)*w;a[5]=(c*E-e*B+f*A)*w;a[6]=(-n*y+r*x-v*t)*w;a[7]=(k*y-o*x+l*t)*w;a[8]=(g*D-h*B+j*z)*w;a[9]=(-c*D+d*B-f*z)*w;a[10]=(n*q-p*x+v*u)*w;a[11]=(-k*q+m*x-l*u)*w;a[12]=(-g*C+h*A-i*z)*w;a[13]=(c*C-d*A+e*z)*w;a[14]=(-n*s+p*t-r*u)*w;a[15]=(k*s-m*t+o*u)*w;return a},toRotationMat:function(b,a){a||(a=mat4.create());a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];a[4]=b[4];a[5]=b[5];a[6]=b[6];a[7]=b[7];a[8]=b[8];a[9]=b[9];a[10]=b[10];a[11]=b[11];a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a},toMat3:function(b,
a){a||(a=mat3.create());a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[4];a[4]=b[5];a[5]=b[6];a[6]=b[8];a[7]=b[9];a[8]=b[10];return a},toInverseMat3:function(b,a){var c=b[0],d=b[1],e=b[2],f=b[4],g=b[5],h=b[6],i=b[8],j=b[9],k=b[10],m=k*g-h*j,o=-k*f+h*i,l=j*f-g*i,n=c*m+d*o+e*l;if(!n)return null;n=1/n;a||(a=mat3.create());a[0]=m*n;a[1]=(-k*d+e*j)*n;a[2]=(h*d-e*g)*n;a[3]=o*n;a[4]=(k*c-e*i)*n;a[5]=(-h*c+e*f)*n;a[6]=l*n;a[7]=(-j*c+d*i)*n;a[8]=(g*c-d*f)*n;return a},multiply:function(b,a,c){c||(c=b);var d=b[0],e=b[1],
f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],m=b[8],o=b[9],l=b[10],n=b[11],p=b[12],r=b[13],v=b[14],b=b[15],u=a[0],t=a[1],x=a[2],s=a[3],q=a[4],y=a[5],z=a[6],A=a[7],B=a[8],C=a[9],D=a[10],E=a[11],w=a[12],F=a[13],G=a[14],a=a[15];c[0]=u*d+t*h+x*m+s*p;c[1]=u*e+t*i+x*o+s*r;c[2]=u*f+t*j+x*l+s*v;c[3]=u*g+t*k+x*n+s*b;c[4]=q*d+y*h+z*m+A*p;c[5]=q*e+y*i+z*o+A*r;c[6]=q*f+y*j+z*l+A*v;c[7]=q*g+y*k+z*n+A*b;c[8]=B*d+C*h+D*m+E*p;c[9]=B*e+C*i+D*o+E*r;c[10]=B*f+C*j+D*l+E*v;c[11]=B*g+C*k+D*n+E*b;c[12]=w*d+F*h+G*m+a*p;c[13]=
w*e+F*i+G*o+a*r;c[14]=w*f+F*j+G*l+a*v;c[15]=w*g+F*k+G*n+a*b;return c},multiplyVec3:function(b,a,c){c||(c=a);var d=a[0],e=a[1],a=a[2];c[0]=b[0]*d+b[4]*e+b[8]*a+b[12];c[1]=b[1]*d+b[5]*e+b[9]*a+b[13];c[2]=b[2]*d+b[6]*e+b[10]*a+b[14];return c},multiplyVec4:function(b,a,c){c||(c=a);var d=a[0],e=a[1],f=a[2],a=a[3];c[0]=b[0]*d+b[4]*e+b[8]*f+b[12]*a;c[1]=b[1]*d+b[5]*e+b[9]*f+b[13]*a;c[2]=b[2]*d+b[6]*e+b[10]*f+b[14]*a;c[3]=b[3]*d+b[7]*e+b[11]*f+b[15]*a;return c},translate:function(b,a,c){var d=a[0],e=a[1],
a=a[2];if(!c||b==c)return b[12]=b[0]*d+b[4]*e+b[8]*a+b[12],b[13]=b[1]*d+b[5]*e+b[9]*a+b[13],b[14]=b[2]*d+b[6]*e+b[10]*a+b[14],b[15]=b[3]*d+b[7]*e+b[11]*a+b[15],b;var f=b[0],g=b[1],h=b[2],i=b[3],j=b[4],k=b[5],m=b[6],o=b[7],l=b[8],n=b[9],p=b[10],r=b[11];c[0]=f;c[1]=g;c[2]=h;c[3]=i;c[4]=j;c[5]=k;c[6]=m;c[7]=o;c[8]=l;c[9]=n;c[10]=p;c[11]=r;c[12]=f*d+j*e+l*a+b[12];c[13]=g*d+k*e+n*a+b[13];c[14]=h*d+m*e+p*a+b[14];c[15]=i*d+o*e+r*a+b[15];return c},scale:function(b,a,c){var d=a[0],e=a[1],a=a[2];if(!c||b==
c)return b[0]*=d,b[1]*=d,b[2]*=d,b[3]*=d,b[4]*=e,b[5]*=e,b[6]*=e,b[7]*=e,b[8]*=a,b[9]*=a,b[10]*=a,b[11]*=a,b;c[0]=b[0]*d;c[1]=b[1]*d;c[2]=b[2]*d;c[3]=b[3]*d;c[4]=b[4]*e;c[5]=b[5]*e;c[6]=b[6]*e;c[7]=b[7]*e;c[8]=b[8]*a;c[9]=b[9]*a;c[10]=b[10]*a;c[11]=b[11]*a;c[12]=b[12];c[13]=b[13];c[14]=b[14];c[15]=b[15];return c},rotate:function(b,a,c,d){var e=c[0],f=c[1],c=c[2],g=Math.sqrt(e*e+f*f+c*c);if(!g)return null;1!=g&&(g=1/g,e*=g,f*=g,c*=g);var h=Math.sin(a),i=Math.cos(a),j=1-i,a=b[0],g=b[1],k=b[2],m=b[3],
o=b[4],l=b[5],n=b[6],p=b[7],r=b[8],v=b[9],u=b[10],t=b[11],x=e*e*j+i,s=f*e*j+c*h,q=c*e*j-f*h,y=e*f*j-c*h,z=f*f*j+i,A=c*f*j+e*h,B=e*c*j+f*h,e=f*c*j-e*h,f=c*c*j+i;d?b!=d&&(d[12]=b[12],d[13]=b[13],d[14]=b[14],d[15]=b[15]):d=b;d[0]=a*x+o*s+r*q;d[1]=g*x+l*s+v*q;d[2]=k*x+n*s+u*q;d[3]=m*x+p*s+t*q;d[4]=a*y+o*z+r*A;d[5]=g*y+l*z+v*A;d[6]=k*y+n*z+u*A;d[7]=m*y+p*z+t*A;d[8]=a*B+o*e+r*f;d[9]=g*B+l*e+v*f;d[10]=k*B+n*e+u*f;d[11]=m*B+p*e+t*f;return d},rotateX:function(b,a,c){var d=Math.sin(a),a=Math.cos(a),e=b[4],
f=b[5],g=b[6],h=b[7],i=b[8],j=b[9],k=b[10],m=b[11];c?b!=c&&(c[0]=b[0],c[1]=b[1],c[2]=b[2],c[3]=b[3],c[12]=b[12],c[13]=b[13],c[14]=b[14],c[15]=b[15]):c=b;c[4]=e*a+i*d;c[5]=f*a+j*d;c[6]=g*a+k*d;c[7]=h*a+m*d;c[8]=e*-d+i*a;c[9]=f*-d+j*a;c[10]=g*-d+k*a;c[11]=h*-d+m*a;return c},rotateY:function(b,a,c){var d=Math.sin(a),a=Math.cos(a),e=b[0],f=b[1],g=b[2],h=b[3],i=b[8],j=b[9],k=b[10],m=b[11];c?b!=c&&(c[4]=b[4],c[5]=b[5],c[6]=b[6],c[7]=b[7],c[12]=b[12],c[13]=b[13],c[14]=b[14],c[15]=b[15]):c=b;c[0]=e*a+i*-d;
c[1]=f*a+j*-d;c[2]=g*a+k*-d;c[3]=h*a+m*-d;c[8]=e*d+i*a;c[9]=f*d+j*a;c[10]=g*d+k*a;c[11]=h*d+m*a;return c},rotateZ:function(b,a,c){var d=Math.sin(a),a=Math.cos(a),e=b[0],f=b[1],g=b[2],h=b[3],i=b[4],j=b[5],k=b[6],m=b[7];c?b!=c&&(c[8]=b[8],c[9]=b[9],c[10]=b[10],c[11]=b[11],c[12]=b[12],c[13]=b[13],c[14]=b[14],c[15]=b[15]):c=b;c[0]=e*a+i*d;c[1]=f*a+j*d;c[2]=g*a+k*d;c[3]=h*a+m*d;c[4]=e*-d+i*a;c[5]=f*-d+j*a;c[6]=g*-d+k*a;c[7]=h*-d+m*a;return c},frustum:function(b,a,c,d,e,f,g){g||(g=mat4.create());var h=
a-b,i=d-c,j=f-e;g[0]=2*e/h;g[1]=0;g[2]=0;g[3]=0;g[4]=0;g[5]=2*e/i;g[6]=0;g[7]=0;g[8]=(a+b)/h;g[9]=(d+c)/i;g[10]=-(f+e)/j;g[11]=-1;g[12]=0;g[13]=0;g[14]=-(2*f*e)/j;g[15]=0;return g},perspective:function(b,a,c,d,e){b=c*Math.tan(b*Math.PI/360);a*=b;return mat4.frustum(-a,a,-b,b,c,d,e)},ortho:function(b,a,c,d,e,f,g){g||(g=mat4.create());var h=a-b,i=d-c,j=f-e;g[0]=2/h;g[1]=0;g[2]=0;g[3]=0;g[4]=0;g[5]=2/i;g[6]=0;g[7]=0;g[8]=0;g[9]=0;g[10]=-2/j;g[11]=0;g[12]=-(b+a)/h;g[13]=-(d+c)/i;g[14]=-(f+e)/j;g[15]=
1;return g},lookAt:function(b,a,c,d){d||(d=mat4.create());var e=b[0],f=b[1],b=b[2],g=c[0],h=c[1],i=c[2],c=a[1],j=a[2];if(e==a[0]&&f==c&&b==j)return mat4.identity(d);var k,m,o,l,c=e-a[0],j=f-a[1],a=b-a[2];l=1/Math.sqrt(c*c+j*j+a*a);c*=l;j*=l;a*=l;k=h*a-i*j;i=i*c-g*a;g=g*j-h*c;(l=Math.sqrt(k*k+i*i+g*g))?(l=1/l,k*=l,i*=l,g*=l):g=i=k=0;h=j*g-a*i;m=a*k-c*g;o=c*i-j*k;(l=Math.sqrt(h*h+m*m+o*o))?(l=1/l,h*=l,m*=l,o*=l):o=m=h=0;d[0]=k;d[1]=h;d[2]=c;d[3]=0;d[4]=i;d[5]=m;d[6]=j;d[7]=0;d[8]=g;d[9]=o;d[10]=a;d[11]=
0;d[12]=-(k*e+i*f+g*b);d[13]=-(h*e+m*f+o*b);d[14]=-(c*e+j*f+a*b);d[15]=1;return d},str:function(b){return"["+b[0]+", "+b[1]+", "+b[2]+", "+b[3]+", "+b[4]+", "+b[5]+", "+b[6]+", "+b[7]+", "+b[8]+", "+b[9]+", "+b[10]+", "+b[11]+", "+b[12]+", "+b[13]+", "+b[14]+", "+b[15]+"]"}},quat4={create:function(b){var a=new glMatrixArrayType(4);b&&(a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3]);return a},set:function(b,a){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];return a},calculateW:function(b,a){var c=b[0],d=b[1],e=
b[2];if(!a||b==a)return b[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e)),b;a[0]=c;a[1]=d;a[2]=e;a[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e));return a},inverse:function(b,a){if(!a||b==a)return b[0]*=-1,b[1]*=-1,b[2]*=-1,b;a[0]=-b[0];a[1]=-b[1];a[2]=-b[2];a[3]=b[3];return a},length:function(b){var a=b[0],c=b[1],d=b[2],b=b[3];return Math.sqrt(a*a+c*c+d*d+b*b)},normalize:function(b,a){a||(a=b);var c=b[0],d=b[1],e=b[2],f=b[3],g=Math.sqrt(c*c+d*d+e*e+f*f);if(0==g)return a[0]=0,a[1]=0,a[2]=0,a[3]=0,a;g=1/g;a[0]=c*g;
a[1]=d*g;a[2]=e*g;a[3]=f*g;return a},multiply:function(b,a,c){c||(c=b);var d=b[0],e=b[1],f=b[2],b=b[3],g=a[0],h=a[1],i=a[2],a=a[3];c[0]=d*a+b*g+e*i-f*h;c[1]=e*a+b*h+f*g-d*i;c[2]=f*a+b*i+d*h-e*g;c[3]=b*a-d*g-e*h-f*i;return c},multiplyVec3:function(b,a,c){c||(c=a);var d=a[0],e=a[1],f=a[2],a=b[0],g=b[1],h=b[2],b=b[3],i=b*d+g*f-h*e,j=b*e+h*d-a*f,k=b*f+a*e-g*d,d=-a*d-g*e-h*f;c[0]=i*b+d*-a+j*-h-k*-g;c[1]=j*b+d*-g+k*-a-i*-h;c[2]=k*b+d*-h+i*-g-j*-a;return c},toMat3:function(b,a){a||(a=mat3.create());var c=
b[0],d=b[1],e=b[2],f=b[3],g=c+c,h=d+d,i=e+e,j=c*g,k=c*h,c=c*i,m=d*h,d=d*i,e=e*i,g=f*g,h=f*h,f=f*i;a[0]=1-(m+e);a[1]=k-f;a[2]=c+h;a[3]=k+f;a[4]=1-(j+e);a[5]=d-g;a[6]=c-h;a[7]=d+g;a[8]=1-(j+m);return a},toMat4:function(b,a){a||(a=mat4.create());var c=b[0],d=b[1],e=b[2],f=b[3],g=c+c,h=d+d,i=e+e,j=c*g,k=c*h,c=c*i,m=d*h,d=d*i,e=e*i,g=f*g,h=f*h,f=f*i;a[0]=1-(m+e);a[1]=k-f;a[2]=c+h;a[3]=0;a[4]=k+f;a[5]=1-(j+e);a[6]=d-g;a[7]=0;a[8]=c-h;a[9]=d+g;a[10]=1-(j+m);a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a},
slerp:function(b,a,c,d){d||(d=b);var e=b[0]*a[0]+b[1]*a[1]+b[2]*a[2]+b[3]*a[3];if(1<=Math.abs(e))return d!=b&&(d[0]=b[0],d[1]=b[1],d[2]=b[2],d[3]=b[3]),d;var f=Math.acos(e),g=Math.sqrt(1-e*e);if(0.0010>Math.abs(g))return d[0]=0.5*b[0]+0.5*a[0],d[1]=0.5*b[1]+0.5*a[1],d[2]=0.5*b[2]+0.5*a[2],d[3]=0.5*b[3]+0.5*a[3],d;e=Math.sin((1-c)*f)/g;c=Math.sin(c*f)/g;d[0]=b[0]*e+a[0]*c;d[1]=b[1]*e+a[1]*c;d[2]=b[2]*e+a[2]*c;d[3]=b[3]*e+a[3]*c;return d},str:function(b){return"["+b[0]+", "+b[1]+", "+b[2]+", "+b[3]+
"]"}};(function(b){function a(a){return{get:function(){return this._data[a]},set:function(b){this._data[a]=b;this._callback&&this._callback(this)},configurable:!1,enumerable:!1}}if(!b){var c=function(a,b,c,g){this._data=new Float32Array(3);"object"==typeof a&&a._data?(this._data[0]=a._data[0],this._data[1]=a._data[1],this._data[2]=a._data[2]):(this._data[0]=a||0,this._data[1]=b||0,this._data[2]=c||0);this._callback="function"==typeof g?g:0},b=c.prototype;Object.defineProperty(b,"x",a(0));Object.defineProperty(b,
"y",a(1));Object.defineProperty(b,"z",a(2));b.toString=function(){return"[object XML3DVec3]"};b.add=function(a){return a._data?new c(this._data[0]+a._data[0],this._data[1]+a._data[1],this._data[2]+a._data[2]):new c(this._data[0]+a.x,this._data[1]+a.y,this._data[2]+a.z)};b.subtract=function(a){return a._data?new c(this._data[0]-a._data[0],this._data[1]-a._data[1],this._data[2]-a._data[2]):new c(this._data[0]-a.x,this._data[1]-a.y,this._data[2]-a.z)};b.length=function(){return Math.sqrt(this._data[0]*
this._data[0]+this._data[1]*this._data[1]+this._data[2]*this._data[2])};b.setVec3Value=function(a){a=/^\s*(\S+)\s+(\S+)\s+(\S+)\s*$/.exec(a);if(!a)throw Error("Wrong format for XML3DVec3::setVec3Value");this._data[0]=+a[1];this._data[1]=+a[2];this._data[2]=+a[3];this._callback&&this._callback(this)};b.set=function(a,b,c){1==arguments.length?(this._data[0]=a._data[0],this._data[1]=a._data[1],this._data[2]=a._data[2]):3==arguments.length&&(this._data[0]=a,this._data[1]=b,this._data[2]=c);this._callback&&
this._callback(this)};b.multiply=function(a){return a._data?new c(this._data[0]*a._data[0],this._data[1]*a._data[1],this._data[2]*a._data[2]):new c(this._data[0]*a.x,this._data[1]*a.y,this._data[2]*a.z)};b.scale=function(a){return new c(this._data[0]*a,this._data[1]*a,this._data[2]*a)};b.cross=function(a){return a._data?new c(this._data[1]*a._data[2]-this._data[2]*a._data[1],this._data[2]*a._data[0]-this._data[0]*a._data[2],this._data[0]*a._data[1]-this._data[1]*a._data[0]):new c(this._data[1]*a.z-
this._data[2]*a.y,this._data[2]*a.x-this._data[0]*a.z,this._data[0]*a.y-this._data[1]*a.x)};b.negate=function(){return new c(-this._data[0],-this._data[1],-this._data[2])};b.dot=function(a){return this._data[0]*a.x+this._data[1]*a.y+this._data[2]*a.z};b.normalize=function(){var a=this.length();if(a)a=1/a;else throw Error();return new c(this._data[0]*a,this._data[1]*a,this._data[2]*a)};XML3D.XML3DVec3=c;window.XML3DVec3=c}})(XML3D._native);(function(b){if(!b){var a=function(b,d,e){var f=this;this._data=new Float32Array(4);this._callback="function"==typeof e?e:0;e=function(){f._updateQuaternion();f._callback&&f._callback(f)};b instanceof a?(this._axis=new window.XML3DVec3(0,0,1,e),this._angle=0,this.setAxisAngle(b.axis,b.angle)):(this._axis=b?new window.XML3DVec3(b.x,b.y,b.z,e):new window.XML3DVec3(0,0,1,e),this._angle=d||0,this._updateQuaternion())},b=a.prototype;Object.defineProperty(b,"axis",{get:function(){return this._axis},set:function(){throw Error("Can't set axis. XML3DRotation::axis is readonly.");
},configurable:!1,enumerable:!1});Object.defineProperty(b,"angle",{get:function(){return this._angle},set:function(a){this._angle=a;this._updateQuaternion();this._callback&&this._callback(this)},configurable:!1,enumerable:!1});b.toString=function(){return"[object XML3DRotation]"};b.setAxisAngle=function(a,b){if("object"!=typeof a||isNaN(b))throw Error("Illegal axis and/or angle values: ( axis="+a+" angle="+b+" )");this._axis._data[0]=a._data[0];this._axis._data[1]=a._data[1];this._axis._data[2]=a._data[2];
this._angle=b;this._updateQuaternion();this._callback&&this._callback(this)};b.setRotation=function(a,b){var e=a.normalize(),f=b.normalize(),g=e.cross(f);g.length()||(g=Math.abs(e._data[1])>=0.9*Math.abs(e._data[0])&&Math.abs(e._data[2])>=0.9*Math.abs(e._data[0])?new window.XML3DVec3(0,-e._data[2],e._data[1]):Math.abs(e._data[0])>=0.9*Math.abs(e._data[1])&&Math.abs(e._data[2])>=0.9*Math.abs(e._data[1])?new window.XML3DVec3(-e._data[2],0,e._data[0]):new window.XML3DVec3(-e._data[1],e._data[0],0));
this.setAxisAngle(g,Math.acos(e.dot(f)))};b._updateQuaternion=function(){var a=this._axis.length();1.0E-5<a?(a=Math.sin(this._angle/2)/a,this._data[0]=this._axis.x*a,this._data[1]=this._axis.y*a,this._data[2]=this._axis.z*a,this._data[3]=Math.cos(this._angle/2)):quat4.set([0,0,0,1],this._data)};b.setAxisAngleValue=function(a){var b=/^\s*(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s*$/.exec(a);if(!b)throw Error("Could not parse AxisAngle string: "+a);this.setAxisAngle(new window.XML3DVec3(+b[1],+b[2],+b[3]),+b[4])};
b.interpolate=function(b,d){var e=quat4.create(),f=new a;quat4.slerp(this._data,b._data,d,e);f._setQuaternion(e);return f};b.setQuaternion=function(a,b){this._setQuaternion([a.x,a.y,a.z,b])};b.set=function(a){this.setAxisAngle(a.axis,a.angle)};b.toMatrix=function(){var a=quat4.create(this._data);a[3]=-a[3];var b=new window.XML3DMatrix;quat4.toMat4(a,b._data);return b};b.rotateVec3=function(a){vec3.create();var b=new window.XML3DVec3;quat4.multiplyVec3(this._data,a._data,b._data);return b};b._setQuaternion=
function(a){var b=Math.sqrt(1-a[3]*a[3]);0.0010>b||isNaN(b)?(this._axis._data[0]=0,this._axis._data[1]=0,this._axis._data[2]=1,this._angle=0):(b=1/b,this._axis._data[0]=a[0]*b,this._axis._data[1]=a[1]*b,this._axis._data[2]=a[2]*b,this._angle=2*Math.acos(a[3]));this._data=quat4.create(a);this._callback&&this._callback(this)};b.multiply=function(b){var d=new a,e=quat4.create();quat4.multiply(this._data,b._data,e);d._setQuaternion(e);return d};b.normalize=function(){var b=this._axis.normalize();return new a(b,
this._angle)};XML3D.XML3DRotation=a;window.XML3DRotation=a}})(XML3D._native);(function(b){b||(b=function(a,b,d){var e=this,f=function(){e._callback&&e._callback(e)};this._min=new window.XML3DVec3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,f);this._max=new window.XML3DVec3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,f);a&&a.min?(this._min.set(a.min),this._max.set(a.max)):(a&&this._min.set(a),b&&this._max.set(b));this._callback="function"==typeof d?d:0},Object.defineProperty(b.prototype,"min",{get:function(){return this._min},set:function(){throw Error("XML3DBox::min is readonly.");
},configurable:!1,enumerable:!1}),Object.defineProperty(b.prototype,"max",{get:function(){return this._max},set:function(){throw Error("XML3DBox::max is readonly.");},configurable:!1,enumerable:!1}),b.prototype.size=function(){var a=this._max.subtract(this._min);0>a.x&&(a.x=0);0>a.y&&(a.y=0);0>a.z&&(a.z=0);return a},b.prototype.center=function(){return this._min.add(this._max).scale(0.5)},b.prototype.makeEmpty=function(){this._min=new window.XML3DVec3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);
this._max=new window.XML3DVec3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);this._callback&&this._callback(this)},b.prototype.isEmpty=function(){return this._min.x>this._max.x||this._min.y>this._max.y||this._min.z>this._max.z},b.prototype.toString=function(){return"[object XML3DBox]"},b.prototype.set=function(a){this._min.set(a.min);this._max.set(a.max);this._callback&&this._callback(this)},b.prototype.extend=function(a){if(a){var b;if(a.constructor===window.XML3DBox)b=a.min,a=a.max;else if(a.constructor===
window.XML3DVec3)b=a;else return;b.x<this._min.x&&(this._min.x=b.x);b.y<this._min.y&&(this._min.y=b.y);b.z<this._min.z&&(this._min.z=b.z);a.x>this._max.x&&(this._max.x=a.x);a.y>this._max.y&&(this._max.y=a.y);a.z>this._max.z&&(this._max.z=a.z)}},XML3D.XML3DBox=b,window.XML3DBox=b)})(XML3D._native);(function(b){function a(a){return{get:function(){return this._data[a]},set:function(b){this._data[a]=b;this._callback&&this._callback(this)},configurable:!1,enumerable:!1}}if(!b){var c=function(a,b,c,g,h,i,j,k,m,o,l,n,p,r,v,u,t){"number"==typeof a&&16<=arguments.length?(this._data=new Float32Array(arguments),this._callback="function"==typeof t?t:0):"object"==typeof a&&1==arguments.length?this._data=new Float32Array(a._data):(this._data=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._callback=
"function"==typeof a?a:0)},b=c.prototype;Object.defineProperty(b,"m11",a(0));Object.defineProperty(b,"m12",a(1));Object.defineProperty(b,"m13",a(2));Object.defineProperty(b,"m14",a(3));Object.defineProperty(b,"m21",a(4));Object.defineProperty(b,"m22",a(5));Object.defineProperty(b,"m23",a(6));Object.defineProperty(b,"m24",a(7));Object.defineProperty(b,"m31",a(8));Object.defineProperty(b,"m32",a(9));Object.defineProperty(b,"m33",a(10));Object.defineProperty(b,"m34",a(11));Object.defineProperty(b,"m41",
a(12));Object.defineProperty(b,"m42",a(13));Object.defineProperty(b,"m43",a(14));Object.defineProperty(b,"m44",a(15));b.toString=function(){return"[object XML3DMatrix]"};b.setMatrixValue=function(a){a=/^(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)$/.exec(a);if(!a)throw{code:DOMException.SYNTAX_ERR,message:"SYNTAX_ERR: DOM Exception 12"};if(17!=a.length)throw{code:DOMException.SYNTAX_ERR,message:"Illegal number of elements: "+
(a.length-1)+"expected: 16"};this._data=new Float32Array(a.slice(1));this._callback&&this._callback(this)};b.multiply=function(a){var b=new c;mat4.multiply(this._data,a._data,b._data);return b};b.inverse=function(){var a=new c;mat4.inverse(this._data,a._data);if(isNaN(a._data[0]))throw Error("Trying to invert matrix that is not invertable.");return a};b.rotate=function(a,b,f){var g=new c;if(void 0===b&&void 0===f)return mat4.rotateZ(this._data,a,g._data),g;mat4.rotateZ(this._data,f,g._data);mat4.rotateY(g._data,
b);mat4.rotateX(g._data,a);return g};b.rotateAxisAngle=function(a,b,f,g){var h=new c;mat4.rotate(this._data,g,[a,b,f],h._data);return h};b.scale=function(a,b,f){var g=new c;f||(f=1);b||(b=a);mat4.scale(this._data,[a,b,f],g._data);return g};b.translate=function(a,b,f){var g=new c;mat4.translate(this._data,[a,b,f],g._data);return g};XML3D.XML3DMatrix=c;window.XML3DMatrix||(window.XML3DMatrix=c)}})(XML3D._native);(function(b){if(!b){var b=function(a,b,e){var f=this,g=function(){f._callback&&f._callback(f)};this._origin=new window.XML3DVec3(0,0,0,g);this._direction=new window.XML3DVec3(0,0,-1,g);a&&a.origin?this.set(a,b):(a&&this._origin.set(a),b&&this._direction.set(b));this._callback="function"==typeof e?e:0},a=b.prototype;Object.defineProperty(a,"origin",{get:function(){return this._origin},set:function(){throw Error("Can't set axis. XML3DRay::origin is readonly.");},configurable:!1,enumerable:!1});Object.defineProperty(a,
"direction",{get:function(){return this._direction},set:function(){throw Error("Can't set axis. XML3DRay::origin is readonly.");},configurable:!1,enumerable:!1});a.set=function(a){this._origin.set(a.origin);this._direction.set(a.direction);this._callback&&this._callback(this)};a.toString=function(){return"[object XML3DRay]"};XML3D.XML3DRay=b;window.XML3DRay=b}})(XML3D._native);XML3D.data=XML3D.data||{};XML3D.data.Adapter=function(b,a){this.factory=b;this.node=a;this.init=function(){}};XML3D.data.Adapter.prototype.notifyChanged=function(){};XML3D.data.Adapter.prototype.isAdapterFor=function(){return!1};XML3D.data.AdapterFactory=function(){};XML3D.data.AdapterFactory.prototype.getAdapter=function(b,a){if(!b||void 0===b._configured)return null;var c=b._configured,d=a||this.name,e=c.adapters[d];if(void 0!==e)return e;if(e=this.createAdapter(b))c.adapters[d]=e,e.init();return e};
XML3D.data.AdapterFactory.prototype.createAdapter=function(){return null};(function(){var b={NODE_INSERTED:0,VALUE_MODIFIED:1,NODE_REMOVED:2,DANGLING_REFERENCE:3,VALID_REFERENCE:4,THIS_REMOVED:5,Notification:function(a){this.type=a}};b.Notification.prototype.toString=function(){return"Notification (type:"+this.type+")"};b.NotificationWrapper=function(a,b){this.wrapped=a;this.type=b};b.NotificationWrapper.prototype.toString=function(){return"NotificationWrapper (type:"+this.type+", wrapped: "+this.wrapped+")"};b.ReferenceNotification=function(a,c,d){this.relatedNode=a;this.attrName=
c;this.value=null;"string"==typeof d&&(d=new XML3D.URI(d));d&&d.valid?"urn"==d.scheme?this.type=b.VALID_REFERENCE:(this.value=XML3D.URIResolver.resolve(d),XML3D.debug.logDebug("Resolved node: #"+d.fragment),this.type=this.value?b.VALID_REFERENCE:b.DANGLING_REFERENCE):this.type=b.DANGLING_REFERENCE};b.ReferenceNotification.prototype.toString=function(){return"ReferenceNotification (type:"+this.type+", value: "+this.value+")"};XML3D.createClass(b.NotificationWrapper,b.Notification);XML3D.events=XML3D.events||
{};XML3D.extend(XML3D.events,b)})();XML3D.config=XML3D.config||{};XML3D.config.isXML3DElement=function(b){return b.nodeType===Node.ELEMENT_NODE&&b.namespaceURI==XML3D.xml3dNS};
XML3D.config.element=function(b,a){if(void 0===b._configured&&XML3D.config.isXML3DElement(b)){var c=XML3D.classInfo[b.localName];if(void 0===c)XML3D.debug.logInfo("Unrecognised element "+b.localName);else{b._configured="xml3d"==b.localName?new XML3D.XML3DHandler(b):new XML3D.ElementHandler(b,a);b._configured.registerAttributes(c);void 0==b.style&&(b.style=null);for(c=b.firstElementChild;c;)XML3D.config.element(c),c=c.nextElementSibling}}};
XML3D.config.configure=function(b,a){Array.isArray(b)&&Array.forEach(b,XML3D.config.element);XML3D.config.element(b,a)};(function(b){if(!b){var b={},a=document.getElementById;b.getElementById=function(b){var c=a.call(this,b);if(c)return c;for(var c=this.getElementsByTagName("*"),f=0;f<c.length;f++){var g=c[f];if(g.getAttribute("id")===b)return g}return null};var c=document.createElementNS;b.createElementNS=function(a,b){var f=c.call(this,a,b);a==XML3D.xml3dNS&&XML3D.config.element(f,!0);return f};XML3D.extend(window.document,b)}})(XML3D._native);
if(-1!=navigator.userAgent.indexOf("WebKit")){var attrModifiedWorks=!1,listener=function(){attrModifiedWorks=!0};document.documentElement.addEventListener("DOMAttrModified",listener,!1);document.documentElement.setAttribute("___TEST___",!0);document.documentElement.removeAttribute("___TEST___");document.documentElement.removeEventListener("DOMAttrModified",listener,!1);attrModifiedWorks||(Element.prototype.__setAttribute=HTMLElement.prototype.setAttribute,Element.prototype.setAttribute=function(b,
a){var c=this.getAttribute(b);this.__setAttribute(b,a);var a=this.getAttribute(b),d=document.createEvent("MutationEvent");d.initMutationEvent("DOMAttrModified",!0,!1,this,c||"",a||"",b,null==c?MutationEvent.ADDITION:MutationEvent.MODIFICATION);this.dispatchEvent(d)},Element.prototype.__removeAttribute=HTMLElement.prototype.removeAttribute,Element.prototype.removeAttribute=function(b){var a=this.getAttribute(b);this.__removeAttribute(b);var c=document.createEvent("MutationEvent");c.initMutationEvent("DOMAttrModified",
!0,!1,this,a,"",b,MutationEvent.REMOVAL);this.dispatchEvent(c)})};(function(){function b(a){var b=a.target._configured,c=b&&b.handlers[a.attrName];if(c){var e=!1;c.setFromAttribute&&(e=c.setFromAttribute(a.newValue));e||(a=new g.NotificationWrapper(a),a.type=g.VALUE_MODIFIED,b.notify(a))}}function a(a){var b=a.target,e=a.relatedNode._configured;e&&(a=new g.NotificationWrapper(a),b.nodeType==Node.TEXT_NODE&&e.handlers.value?(a.type=g.VALUE_MODIFIED,e.handlers.value.resetValue()):(a.type=g.NODE_REMOVED,e.notify(a),b._configured&&(a.type=g.THIS_REMOVED,c(b,a))))}function c(a,
b){a._configured&&(a._configured.notify(b),a._configured.remove(b));for(var e=a.firstElementChild;e;)c(e,b),e=e.nextElementSibling}function d(a){var b=a.target,c=a.relatedNode._configured;c&&a.currentTarget!==b&&(a=new g.NotificationWrapper(a),b.nodeType==Node.TEXT_NODE&&c.handlers.value?(a.type=g.VALUE_MODIFIED,c.handlers.value.resetValue()):(XML3D.config.element(b),a.type=g.NODE_INSERTED),c.notify(a))}function e(a,b,c){var e={get:function(){return c[a]}};try{Object.defineProperty(b,a,e)}catch(d){XML3D.debug.logWarning("Can't configure "+
b.nodeName+"::"+a)}}var f={},g=XML3D.events;f.ElementHandler=function(c,e){c&&(this.element=c,this.handlers={},this.adapters={},e&&(c.addEventListener("DOMNodeRemoved",a,!0),c.addEventListener("DOMNodeInserted",d,!0),c.addEventListener("DOMAttrModified",b,!1),this.monitoring=!0))};f.ElementHandler.prototype.registerAttributes=function(a){var b=this.element,c;for(c in a)if(void 0===a[c])delete b[c];else if(void 0!==a[c].a){var e=a[c].id||c,d=new a[c].a(b,e,a[c].params);this.handlers[e]=d;try{Object.defineProperty(b,
c,d.desc)}catch(g){XML3D.debug.logWarning("Can't configure "+b.nodeName+"::"+c)}}else void 0!==a[c].m?b[c]=a[c].m:XML3D.debug.logError("Can't configure "+b.nodeName+"::"+c);return b};f.ElementHandler.prototype.registerMixed=function(){this.element.addEventListener("DOMCharacterDataModified",this,!1)};f.ElementHandler.prototype.handleEvent=function(a){XML3D.debug.logDebug(a.type+" at "+a.currentTarget.localName+"/"+a.target);var b=new g.NotificationWrapper(a);switch(a.type){case "DOMCharacterDataModified":b.type=
g.VALUE_MODIFIED,this.handlers.value.resetValue(),this.notify(b)}};f.ElementHandler.prototype.notify=function(a){var b=this.adapters,c;for(c in b)try{b[c].notifyChanged(a)}catch(e){XML3D.debug.logError(e)}};f.ElementHandler.prototype.addOpposite=function(a){(this.opposites||(this.opposites=[])).push(a)};f.ElementHandler.prototype.removeOpposite=function(a){for(var b in this.opposites)if(this.opposites[b].relatedNode===a.relatedNode){this.opposites.splice(b,1);break}};f.ElementHandler.prototype.notifyOpposite=
function(a){a.value&&a.value._configured&&a.value._configured.addOpposite(a)};f.ElementHandler.prototype.remove=function(){if(this.opposites)for(var a in this.opposites){var b=this.opposites[a];if(b.relatedNode._configured){var c=new g.ReferenceNotification(b.relatedNode,b.attrName);b.relatedNode._configured.notify(c)}}for(var e in this.handlers)a=this.handlers[e],a.remove&&a.remove()};f.ElementHandler.prototype.resolve=function(a){a=new XML3D.URI(this.element[a]);return a.valid&&a.fragment?XML3D.URIResolver.resolve(a):
null};f.ElementHandler.prototype.toString=function(){return"ElementHandler ("+this.element.nodeName+", id: "+this.element.id+")"};var h="clientHeight,clientLeft,clientTop,clientWidth,offsetHeight,offsetLeft,offsetTop,offsetWidth".split(",");f.XML3DHandler=function(a){f.ElementHandler.call(this,a,!0);var b=document.createElement("canvas");b.width=800;b.height=600;this.canvas=b;for(var c in h)e(h[c],a,b);a.getBoundingClientRect=function(){return b.getBoundingClientRect()}};XML3D.createClass(f.XML3DHandler,
f.ElementHandler);XML3D.extend(XML3D,f)})();(function(){var b=function(a){switch(a.toLowerCase()){case "true":case "1":return!0;case "false":case "0":return!1;default:return Boolean(a)}},a={},c=XML3D.events,d=function(){this.setter=function(){}};a.StringAttributeHandler=function(a,b){this.desc={get:function(){return this.getAttribute(b)||""},set:function(a){this.setAttribute(b,a)}}};a.ReferenceHandler=function(a,b){this.setFromAttribute=function(e){e=new c.ReferenceNotification(a,b,e);a._configured.notify(e);a._configured.notifyOpposite(e);
return!0};this.remove=function(){var e=new c.ReferenceNotification(a,b,a.getAttribute(b));e.type==c.VALID_REFERENCE&&e.value._configured&&e.value._configured.removeOpposite(e)};this.desc={get:function(){return this.getAttribute(b)||""},set:function(a){this.setAttribute(b,a)}};a._configured.notifyOpposite(new c.ReferenceNotification(a,b,a.getAttribute(b)))};a.EnumAttributeHandler=function(a,b,c){d.call(this,a);var e=c.d;this.setFromAttribute=function(a){e=(a=a.toLowerCase())&&void 0!==c.e[a]?c.e[a]:
c.d;return!1};a.hasAttribute(b)&&this.setFromAttribute(a.getAttribute(b));this.desc={get:function(){return c.e[e]},set:function(a){this.setAttribute(b,a);e=(a="string"==typeof a?a.toLowerCase():void 0)&&void 0!==c.e[a]?c.e[a]:c.d}}};a.EnumAttributeHandler.prototype=new d;a.EnumAttributeHandler.prototype.constructor=a.EnumAttributeHandler;a.EventAttributeHandler=function(a,b){d.call(this,a);var c=null;this.setFromAttribute=function(){c=null;return!1};this.desc={get:function(){return c?c:!this.hasAttribute(b)||
void 0===c?null:eval("c = function onclick(event){\n  "+this.getAttribute(b)+"\n}")},set:function(e){c="function"==typeof e?e:void 0;this._configured.notify({attrName:b,relatedNode:a})}}};a.EventAttributeHandler.prototype=new d;a.EventAttributeHandler.prototype.constructor=a.EventAttributeHandler;a.IntAttributeHandler=function(a,b,c){var e=c;this.setFromAttribute=function(d){e=(d=d.match(/^\d+/))?+d[0]:c;a._configured.canvas&&(a._configured.canvas[b]=e);return!1};a.hasAttribute(b)&&this.setFromAttribute(a.getAttribute(b));
this.desc={get:function(){return e},set:function(a){a=+a;e=isNaN(a)?c:Math.floor(a);this.setAttribute(b,e+"")}}};a.IntAttributeHandler.prototype=new d;a.IntAttributeHandler.prototype.constructor=a.IntAttributeHandler;a.FloatAttributeHandler=function(a,b,c){var e=c;this.setFromAttribute=function(a){a=+a;e=isNaN(a)?c:a;return!1};a.hasAttribute(b)&&this.setFromAttribute(a.getAttribute(b));this.desc={get:function(){return e},set:function(a){a=+a;e=isNaN(a)?c:a;this.setAttribute(b,e+"")}}};a.BoolAttributeHandler=
function(a,c,e){var d=e;this.setFromAttribute=function(a){d=b(a+"");return!1};a.hasAttribute(c)&&this.setFromAttribute(a.getAttribute(c));this.desc={get:function(){return d},set:function(a){d=Boolean(a);this.setAttribute(c,d+"")}}};a.XML3DVec3AttributeHandler=function(a,b,c){var e=null,d=this,f=function(c){a.setAttribute(b,c.x+" "+c.y+" "+c.z)};this.setFromAttribute=function(a){e||(e=new window.XML3DVec3(0,0,0,f));(a=/^\s*(\S+)\s+(\S+)\s+(\S+)\s*$/.exec(a))?(e._data[0]=a[1],e._data[1]=a[2],e._data[2]=
a[3]):e._data.set(c);return!1};this.desc={get:function(){e||(this.hasAttribute(b)?d.setFromAttribute(this.getAttribute(b)):e=new window.XML3DVec3(c[0],c[1],c[2],f));return e},set:function(){throw Error("Can't set "+a.nodeName+"::"+b+": it's readonly");}}};a.XML3DRotationAttributeHandler=function(a,b,c){var e=null,d=this,f=function(c){a.setAttribute(b,c.axis.x+" "+c.axis.y+" "+c.axis.z+" "+c.angle)};this.setFromAttribute=function(a){e||(e=new window.XML3DRotation(null,null,f));(a=/^\s*(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s*$/.exec(a))?
(e._axis._data[0]=+a[1],e._axis._data[1]=+a[2],e._axis._data[2]=+a[3],e._angle=+a[4]):(e._axis._data[0]=c[0],e._axis._data[1]=c[1],e._axis._data[2]=c[2],e._angle=c[3]);e._updateQuaternion();return!1};this.desc={get:function(){e||(this.hasAttribute(b)?d.setFromAttribute(this.getAttribute(b)):e=new window.XML3DRotation(new window.XML3DVec3(c[0],c[1],c[2]),c[3],f));return e},set:function(){throw Error("Can't set "+a.nodeName+"::"+b+": it's readonly");}}};var e=function(a,b,c){a._configured.registerMixed();
return{get:function(){b.value||(b.value=c.parse(a));return b.value},set:function(){throw Error("Can't set "+a.nodeName+"::value: it's readonly");}}},f=function(a){for(var b="",a=a.firstChild;a;)b+=3==a.nodeType?a.textContent:" ",a=a.nextSibling;return b};a.FloatArrayValueHandler=function(a){var b={};this.desc=e(a,b,this);this.resetValue=function(){b.value=null}};a.FloatArrayValueHandler.prototype.parse=function(a){return(a=f(a).match(/([+\-0-9eE\.]+)/g))?new Float32Array(a):new Float32Array};a.Float2ArrayValueHandler=
a.FloatArrayValueHandler;a.Float3ArrayValueHandler=a.FloatArrayValueHandler;a.Float4ArrayValueHandler=a.FloatArrayValueHandler;a.Float4x4ArrayValueHandler=a.FloatArrayValueHandler;a.IntArrayValueHandler=function(a){var b={};this.desc=e(a,b,this);this.resetValue=function(){b.value=null}};a.IntArrayValueHandler.prototype.parse=function(a){return(a=f(a).match(/([+\-0-9]+)/g))?new Int32Array(a):new Int32Array};a.BoolArrayValueHandler=function(a){var b={};this.desc=e(a,b,this);this.resetValue=function(){b.value=
null}};a.BoolArrayValueHandler.prototype.parse=function(a){a=f(a).match(/(true|false|0|1)/ig);return!a?new Uint8Array:(a=Array.map(a,b))?new Uint8Array(a):new Uint8Array};a.CanvasStyleHandler=function(a,b){var c=a._configured.canvas;this.desc={};this.desc.get=function(){return c.style};this.desc.set=function(){};this.setFromAttribute=function(a){c.setAttribute(b,a)};a.hasAttribute(b)&&this.setFromAttribute(a.getAttribute(b))};a.CanvasClassHandler=function(a,b){var c=a._configured.canvas;c.className=
"_xml3d";this.desc={};this.desc.get=function(){return c.className};this.desc.set=function(a){c.className=a};this.setFromAttribute=function(a){c.setAttribute(b,a+" _xml3d")};a.hasAttribute(b)&&this.setFromAttribute(a.getAttribute(b))};XML3D.extend(XML3D,a)})();XML3D.methods=XML3D.methods||{};
new function(){var b={xml3dCreateXML3DVec3:function(){return new window.XML3DVec3},xml3dCreateXML3DRay:function(){return new window.XML3DRay},xml3dGetElementByRay:function(){XML3D.debug.logError(this.nodeName+"::getElementByRay is not implemeted yet.");return null},xml3dCreateXML3DMatrix:function(){return new window.XML3DMatrix},xml3dCreateXML3DRotation:function(){return new window.XML3DRotation},viewGetDirection:function(){return this.orientation.rotateVec3(new window.XML3DVec3(0,0,-1))},viewSetPosition:function(a){this.position=
a}},a=vec3.create(),c=vec3.create(),d=vec3.create();quat4.setFromMat3=function(a,b){var c=a[0]+a[4]+a[8];0<c?(c=2*Math.sqrt(c+1),b[0]=(a[7]-a[5])/c,b[1]=(a[2]-a[6])/c,b[2]=(a[3]-a[1])/c,b[3]=0.25*c):a[0]>a[4]&a[0]>a[8]?(c=2*Math.sqrt(1+a[0]-a[4]-a[8]),b[3]=(a[7]-a[5])/c,b[0]=0.25*c,b[1]=(a[1]+a[3])/c,b[2]=(a[2]+a[6])/c):a[4]>a[8]?(c=2*Math.sqrt(1+a[4]-a[0]-a[8]),b[3]=(a[2]-a[6])/c,b[0]=(a[1]+a[3])/c,b[1]=0.25*c,b[2]=(a[5]+a[7])/c):(c=2*Math.sqrt(1+a[8]-a[0]-a[4]),b[3]=(a[3]-a[1])/c,b[0]=(a[2]+a[6])/
c,b[1]=(a[5]+a[7])/c,b[2]=0.25*c)};quat4.setFromBasis=function(a,b,c,d){var i=1/vec3.length(a),j=1/vec3.length(b),k=1/vec3.length(c),m=mat3.create();m[0]=a[0]*i;m[1]=b[0]*j;m[2]=c[0]*k;m[3]=a[1]*i;m[4]=b[1]*j;m[5]=c[1]*k;m[6]=a[2]*i;m[7]=b[2]*j;m[8]=c[2]*k;quat4.setFromMat3(m,d)};b.viewSetDirection=function(b){var b=b||new window.XML3DVec3(0,0,-1),b=b.normalize(),f=this.orientation.rotateVec3(new window.XML3DVec3(0,1,0)),f=f.normalize();vec3.cross(b._data,f._data,a);vec3.length(a)||(a=this.orientation.rotateVec3(new window.XML3DVec3(1,
0,0))._data);vec3.cross(a,b._data,c);vec3.negate(b._data,d);b=quat4.create();quat4.setFromBasis(a,c,d,b);this.orientation._setQuaternion(b)};b.viewSetUpVector=function(a){var a=a||new window.XML3DVec3(0,1,0),a=a.normalize(),b=new window.XML3DRotation;b.setRotation(new window.XML3DVec3(0,1,0),a);b=this.orientation.multiply(b);b=b.normalize();this.orientation.set(b)};b.viewGetUpVector=function(){return this.orientation.rotateVec3(new window.XML3DVec3(0,1,0))};b.viewLookAt=function(a){this.setDirection(a.subtract(this.position))};
b.viewGetViewMatrix=function(){var a=this._configured.adapters||{},b;for(b in a)if(a[b].getViewMatrix)return a[b].getViewMatrix();a=this.position;b=this.orientation;var c=b.axis;return(new window.XML3DMatrix).translate(a.x,a.y,a.z).rotateAxisAngle(c.x,c.y,c.z,b.angle).inverse()};b.xml3dGetElementByPoint=function(a,b,c,d){var i=this._configured.adapters||{},j;for(j in i)if(i[j].getElementByPoint)return i[j].getElementByPoint(a,b,c,d);return null};b.xml3dGenerateRay=function(a,b){var c=this._configured.adapters||
{},d;for(d in c)if(c[d].xml3dGenerateRay)return c[d].xml3dGenerateRay(a,b);return new window.XML3DRay};b.groupGetLocalMatrix=function(){var a=this._configured.adapters||{},b;for(b in a)if(a[b].getLocalMatrix)return a[b].getLocalMatrix();return new window.XML3DMatrix};b.groupGetBoundingBox=function(){var a=this._configured.adapters||{},b;for(b in a)if(a[b].getBoundingBox)return a[b].getBoundingBox();return new window.XML3DBox};b.xml3dGetBoundingBox=b.groupGetBoundingBox;b.meshGetBoundingBox=function(){var a=
this._configured.adapters||{},b;for(b in a)if(a[b].getBoundingBox)return a[b].getBoundingBox();return new window.XML3DBox};b.XML3DGraphTypeGetWorldMatrix=function(){var a=this._configured.adapters||{},b;for(b in a)if(a[b].getWorldMatrix)return a[b].getWorldMatrix();return new window.XML3DMatrix};b.dataGetOutputFieldNames=function(){XML3D.debug.logError(this.nodeName+"::getOutputFieldNames is not implemeted yet.");return null};b.dataGetResult=function(){XML3D.debug.logError(this.nodeName+"::getResult is not implemeted yet.");
return null};XML3D.extend(XML3D.methods,b)};XML3D.MeshTypes={};XML3D.MeshTypes.triangles=0;XML3D.MeshTypes[0]="triangles";XML3D.MeshTypes.trianglestrips=1;XML3D.MeshTypes[1]="trianglestrips";XML3D.MeshTypes.lines=2;XML3D.MeshTypes[2]="lines";XML3D.MeshTypes.linestrips=3;XML3D.MeshTypes[3]="linestrips";XML3D.TextureTypes={};XML3D.TextureTypes["2d"]=0;XML3D.TextureTypes[0]="2d";XML3D.TextureTypes["1d"]=1;XML3D.TextureTypes[1]="1d";XML3D.TextureTypes["3d"]=2;XML3D.TextureTypes[2]="3d";XML3D.FilterTypes={};XML3D.FilterTypes.none=0;
XML3D.FilterTypes[0]="none";XML3D.FilterTypes.nearest=1;XML3D.FilterTypes[1]="nearest";XML3D.FilterTypes.linear=2;XML3D.FilterTypes[2]="linear";XML3D.WrapTypes={};XML3D.WrapTypes.clamp=0;XML3D.WrapTypes[0]="clamp";XML3D.WrapTypes.repeat=1;XML3D.WrapTypes[1]="repeat";XML3D.WrapTypes.border=2;XML3D.WrapTypes[2]="border";XML3D.DataFieldType={};XML3D.DataFieldType["float "]=0;XML3D.DataFieldType[0]="float ";XML3D.DataFieldType["float2 "]=1;XML3D.DataFieldType[1]="float2 ";XML3D.DataFieldType.float3=2;
XML3D.DataFieldType[2]="float3";XML3D.DataFieldType.float4=3;XML3D.DataFieldType[3]="float4";XML3D.DataFieldType.float4x4=4;XML3D.DataFieldType[4]="float4x4";XML3D.DataFieldType["int"]=5;XML3D.DataFieldType[5]="int";XML3D.DataFieldType.bool=6;XML3D.DataFieldType[6]="bool";XML3D.DataFieldType.texture=7;XML3D.DataFieldType[7]="texture";XML3D.DataFieldType.video=8;XML3D.DataFieldType[8]="video";XML3D.classInfo={};
XML3D.classInfo.xml3d={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.CanvasClassHandler,id:"class"},style:{a:XML3D.CanvasStyleHandler},onclick:{a:XML3D.EventAttributeHandler},ondblclick:{a:XML3D.EventAttributeHandler},onmousedown:{a:XML3D.EventAttributeHandler},onmouseup:{a:XML3D.EventAttributeHandler},onmouseover:{a:XML3D.EventAttributeHandler},onmousemove:{a:XML3D.EventAttributeHandler},onmouseout:{a:XML3D.EventAttributeHandler},onkeypress:{a:XML3D.EventAttributeHandler},onkeydown:{a:XML3D.EventAttributeHandler},
onkeyup:{a:XML3D.EventAttributeHandler},height:{a:XML3D.IntAttributeHandler,params:600},width:{a:XML3D.IntAttributeHandler,params:800},createXML3DVec3:{m:XML3D.methods.xml3dCreateXML3DVec3},createXML3DRotation:{m:XML3D.methods.xml3dCreateXML3DRotation},createXML3DMatrix:{m:XML3D.methods.xml3dCreateXML3DMatrix},createXML3DRay:{m:XML3D.methods.xml3dCreateXML3DRay},getElementByPoint:{m:XML3D.methods.xml3dGetElementByPoint},generateRay:{m:XML3D.methods.xml3dGenerateRay},getElementByRay:{m:XML3D.methods.xml3dGetElementByRay},
getBoundingBox:{m:XML3D.methods.xml3dGetBoundingBox},activeView:{a:XML3D.ReferenceHandler},_term:void 0};XML3D.classInfo.data={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},map:{a:XML3D.StringAttributeHandler},expose:{a:XML3D.StringAttributeHandler},getResult:{m:XML3D.methods.dataGetResult},getOutputFieldNames:{m:XML3D.methods.dataGetOutputFieldNames},src:{a:XML3D.ReferenceHandler},script:{a:XML3D.ReferenceHandler},_term:void 0};
XML3D.classInfo.defs={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},_term:void 0};
XML3D.classInfo.group={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},onclick:{a:XML3D.EventAttributeHandler},ondblclick:{a:XML3D.EventAttributeHandler},onmousedown:{a:XML3D.EventAttributeHandler},onmouseup:{a:XML3D.EventAttributeHandler},onmouseover:{a:XML3D.EventAttributeHandler},onmousemove:{a:XML3D.EventAttributeHandler},onmouseout:{a:XML3D.EventAttributeHandler},onkeypress:{a:XML3D.EventAttributeHandler},onkeydown:{a:XML3D.EventAttributeHandler},onkeyup:{a:XML3D.EventAttributeHandler},
visible:{a:XML3D.BoolAttributeHandler,params:!0},getWorldMatrix:{m:XML3D.methods.XML3DGraphTypeGetWorldMatrix},getLocalMatrix:{m:XML3D.methods.groupGetLocalMatrix},getBoundingBox:{m:XML3D.methods.groupGetBoundingBox},transform:{a:XML3D.ReferenceHandler},shader:{a:XML3D.ReferenceHandler},_term:void 0};
XML3D.classInfo.mesh={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},onclick:{a:XML3D.EventAttributeHandler},ondblclick:{a:XML3D.EventAttributeHandler},onmousedown:{a:XML3D.EventAttributeHandler},onmouseup:{a:XML3D.EventAttributeHandler},onmouseover:{a:XML3D.EventAttributeHandler},onmousemove:{a:XML3D.EventAttributeHandler},onmouseout:{a:XML3D.EventAttributeHandler},onkeypress:{a:XML3D.EventAttributeHandler},onkeydown:{a:XML3D.EventAttributeHandler},onkeyup:{a:XML3D.EventAttributeHandler},
visible:{a:XML3D.BoolAttributeHandler,params:!0},type:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.MeshTypes,d:0}},getWorldMatrix:{m:XML3D.methods.XML3DGraphTypeGetWorldMatrix},getBoundingBox:{m:XML3D.methods.meshGetBoundingBox},src:{a:XML3D.ReferenceHandler},_term:void 0};
XML3D.classInfo.transform={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},translation:{a:XML3D.XML3DVec3AttributeHandler,params:[0,0,0]},scale:{a:XML3D.XML3DVec3AttributeHandler,params:[1,1,1]},rotation:{a:XML3D.XML3DRotationAttributeHandler,params:[0,0,1,0]},center:{a:XML3D.XML3DVec3AttributeHandler,params:[0,0,0]},scaleOrientation:{a:XML3D.XML3DRotationAttributeHandler,params:[0,0,1,0]},_term:void 0};
XML3D.classInfo.shader={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},script:{a:XML3D.ReferenceHandler},src:{a:XML3D.ReferenceHandler},_term:void 0};
XML3D.classInfo.light={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},onclick:{a:XML3D.EventAttributeHandler},ondblclick:{a:XML3D.EventAttributeHandler},onmousedown:{a:XML3D.EventAttributeHandler},onmouseup:{a:XML3D.EventAttributeHandler},onmouseover:{a:XML3D.EventAttributeHandler},onmousemove:{a:XML3D.EventAttributeHandler},onmouseout:{a:XML3D.EventAttributeHandler},onkeypress:{a:XML3D.EventAttributeHandler},onkeydown:{a:XML3D.EventAttributeHandler},onkeyup:{a:XML3D.EventAttributeHandler},
visible:{a:XML3D.BoolAttributeHandler,params:!0},global:{a:XML3D.BoolAttributeHandler,params:!1},intensity:{a:XML3D.FloatAttributeHandler,params:1},getWorldMatrix:{m:XML3D.methods.XML3DGraphTypeGetWorldMatrix},shader:{a:XML3D.ReferenceHandler},_term:void 0};XML3D.classInfo.lightshader={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},script:{a:XML3D.ReferenceHandler},src:{a:XML3D.ReferenceHandler},_term:void 0};
XML3D.classInfo.script={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},value:{a:XML3D.StringAttributeHandler},src:{a:XML3D.StringAttributeHandler},type:{a:XML3D.StringAttributeHandler},_term:void 0};XML3D.classInfo["float"]={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},value:{a:XML3D.FloatArrayValueHandler},_term:void 0};
XML3D.classInfo.float2={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},value:{a:XML3D.Float2ArrayValueHandler},_term:void 0};XML3D.classInfo.float3={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},value:{a:XML3D.Float3ArrayValueHandler},_term:void 0};
XML3D.classInfo.float4={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},value:{a:XML3D.Float4ArrayValueHandler},_term:void 0};XML3D.classInfo.float4x4={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},value:{a:XML3D.Float4x4ArrayValueHandler},_term:void 0};
XML3D.classInfo["int"]={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},value:{a:XML3D.IntArrayValueHandler},_term:void 0};XML3D.classInfo.bool={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},value:{a:XML3D.BoolArrayValueHandler},_term:void 0};
XML3D.classInfo.texture={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},type:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.TextureTypes,d:0}},filterMin:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.FilterTypes,d:2}},filterMag:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.FilterTypes,d:2}},filterMip:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.FilterTypes,d:1}},wrapS:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.WrapTypes,
d:0}},wrapT:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.WrapTypes,d:0}},wrapU:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.WrapTypes,d:0}},borderColor:{a:XML3D.StringAttributeHandler},_term:void 0};XML3D.classInfo.img={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},src:{a:XML3D.StringAttributeHandler},_term:void 0};
XML3D.classInfo.video={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},src:{a:XML3D.StringAttributeHandler},_term:void 0};
XML3D.classInfo.view={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},onclick:{a:XML3D.EventAttributeHandler},ondblclick:{a:XML3D.EventAttributeHandler},onmousedown:{a:XML3D.EventAttributeHandler},onmouseup:{a:XML3D.EventAttributeHandler},onmouseover:{a:XML3D.EventAttributeHandler},onmousemove:{a:XML3D.EventAttributeHandler},onmouseout:{a:XML3D.EventAttributeHandler},onkeypress:{a:XML3D.EventAttributeHandler},onkeydown:{a:XML3D.EventAttributeHandler},onkeyup:{a:XML3D.EventAttributeHandler},
visible:{a:XML3D.BoolAttributeHandler,params:!0},position:{a:XML3D.XML3DVec3AttributeHandler,params:[0,0,0]},orientation:{a:XML3D.XML3DRotationAttributeHandler,params:[0,0,1,0]},fieldOfView:{a:XML3D.FloatAttributeHandler,params:0.785398},getWorldMatrix:{m:XML3D.methods.XML3DGraphTypeGetWorldMatrix},setDirection:{m:XML3D.methods.viewSetDirection},setUpVector:{m:XML3D.methods.viewSetUpVector},lookAt:{m:XML3D.methods.viewLookAt},getDirection:{m:XML3D.methods.viewGetDirection},getUpVector:{m:XML3D.methods.viewGetUpVector},
getViewMatrix:{m:XML3D.methods.viewGetViewMatrix},_term:void 0};XML3D.webgl=XML3D.webgl||{};XML3D.webgl.MAXFPS=30;
(function(){function b(a,b){this.canvas=a;this.xml3dElem=b;this.gl=a.getContext("experimental-webgl",{preserveDrawingBuffer:!0});this.needPickingDraw=this.needDraw=!0;this._pickingDisabled=!1;this._lastPickedObj=null;this.isDragging=this.mouseMovePickingEnabled=!1;this.timeNow=Date.now()/1E3;this.postProcessShaders=[];this.canvasInfo={id:a.id,mouseButtonsDown:[!1,!1]};this.registerCanvasListeners();var d=this;this._tick=function(){d.update()&&d.draw();window.requestAnimFrame(d._tick,XML3D.webgl.MAXFPS)};
this.redraw=function(a,b){void 0!==this.needDraw?(this.needDraw=!0,this.needPickingDraw=this.needPickingDraw||(void 0===b?!0:b)):d.needDraw=!0};this.renderer=new XML3D.webgl.Renderer(this,a.clientWidth,a.clientHeight)}b.prototype.registerCanvasListeners=function(){var a=this,b=this.canvas;b.addEventListener("mousedown",function(b){a.mouseDown(b)},!1);b.addEventListener("mouseup",function(b){a.mouseUp(b)},!1);b.addEventListener("mousemove",function(b){a.mouseMove(b)},!1);b.addEventListener("click",
function(b){a.click(b)},!1);b.addEventListener("dblclick",function(b){a.click(b,!0)},!1);b.addEventListener("mousewheel",function(b){a.mouseWheel(b)},!1);b.addEventListener("DOMMouseScroll",function(b){a.mouseWheel(b)},!1);b.addEventListener("mouseout",function(b){a.mouseOut(b)},!1);b=this.xml3dElem.getAttribute("contextmenu");(!b||"false"==b)&&this.canvas.addEventListener("contextmenu",function(a){XML3D.webgl.stopEvent(a)},!1)};b.prototype.start=function(){var a=this.gl;a.pixelStorei(a.PACK_ALIGNMENT,
1);a.pixelStorei(a.UNPACK_ALIGNMENT,1);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);a.pixelStorei(a.UNPACK_COLORSPACE_CONVERSION_WEBGL,a.BROWSER_DEFAULT_WEBGL);this._tick()};b.prototype.resize=function(a,b,d){if(1>b||1>d)return!1;this.renderer.resize(b,d);return!0};b.prototype.renderPick=function(a,b){this._pickingDisabled||(this.renderer.renderPickingPass(a,this.canvas.height-b,this.needPickingDraw),this.needPickingDraw=!1)};b.prototype.renderPickedNormals=
function(a,b,d){a&&!this._pickingDisabled&&this.renderer.renderPickedNormals(a,b,this.canvas.height-d)};b.prototype.generateRay=function(a,b){var d=[0,0];d[2]=this.renderer.width;d[3]=this.renderer.height;var e=this.renderer.camera.viewMatrix,f=this.renderer.camera.getProjectionMatrix(d[2]/d[3]),g=new window.XML3DRay,h=[],i=[];if(!1===GLU.unProject(a,b,0,e,f,d,h)||!1===GLU.unProject(a,b,1,e,f,d,i))return g;g.origin=this.renderer.currentView.position;g.direction=new window.XML3DVec3(i[0]-h[0],i[1]-
h[1],i[2]-h[2]);g.direction=g.direction.normalize();return g};b.prototype.update=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("update",!0,!0,null);this.xml3dElem.dispatchEvent(a);return this.needDraw};b.prototype.draw=function(){try{var a=Date.now(),b=this.renderer.render(this.gl),d=Date.now();this.needDraw=!1;this.dispatchFrameDrawnEvent(a,d,b)}catch(e){throw XML3D.debug.logException(e),e;}};b.prototype.dispatchMouseEvent=function(a,b,d,e,f,g){if(null===f||void 0===f)f=
document.createEvent("MouseEvents"),f.initMouseEvent(a,!0,!0,window,0,0,0,d,e,!1,!1,!1,!1,b,null);a=this.copyMouseEvent(f);this.initExtendedMouseEvent(a,d,e);d=null;d=void 0!==g&&null!==g?g:this.xml3dElem.currentPickObj?this.xml3dElem.currentPickObj:this.xml3dElem;d.dispatchEvent(a);d=this.xml3dElem;d.dispatchEvent(a)};b.prototype.copyMouseEvent=function(a){var b=document.createEvent("MouseEvents");b.initMouseEvent(a.type,a.bubbles,a.cancelable,a.view,a.detail,a.screenX,a.screenY,a.clientX,a.clientY,
a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,a.button,a.relatedTarget);return b};b.prototype.initExtendedMouseEvent=function(a,b,d){var e=this,f=this.xml3dElem;a.__defineGetter__("normal",function(){e.renderPickedNormals(f.currentPickObj,b,d);var a=f.currentPickNormal.v;return new window.XML3DVec3(a[0],a[1],a[2])});a.__defineGetter__("position",function(){return f.currentPickPos})};b.prototype.mouseUp=function(a){this.canvasInfo.mouseButtonsDown[a.button]=!1;var b=this.getMousePosition(a);this.isDragging&&
(this.needPickingDraw=!0,this.isDragging=!1);this.renderPick(b.x,b.y);this.dispatchMouseEvent("mouseup",a.button,b.x,b.y,a);return!1};b.prototype.mouseDown=function(a){this.canvasInfo.mouseButtonsDown[a.button]=!0;var b=this.getMousePosition(a);this.renderPick(b.x,b.y);this.dispatchMouseEvent("mousedown",a.button,b.x,b.y,a);return!1};b.prototype.click=function(a,b){var d=this.getMousePosition(a);if(this.isDragging)this.needPickingDraw=!0;else return!0==b?this.dispatchMouseEvent("dblclick",a.button,
d.x,d.y,a):this.dispatchMouseEvent("click",a.button,d.x,d.y,a),!1};b.prototype.mouseMove=function(a){var b=this.getMousePosition(a);this.canvasInfo.mouseButtonsDown[0]&&(this.isDragging=!0);this.dispatchMouseEvent("mousemove",0,b.x,b.y,a,this.xml3dElem);if(this.mouseMovePickingEnabled)return this.renderPick(b.x,b.y),a=null,this.xml3dElem.currentPickObj&&(a=this.xml3dElem.currentPickObj),a!==this._lastPickedObj&&(this._lastPickedObj&&this.dispatchMouseEvent("mouseout",0,b.x,b.y,null,this._lastPickedObj),
a&&this.dispatchMouseEvent("mouseover",0,b.x,b.y),this._lastPickedObj=a),!1};b.prototype.mouseOut=function(a){var b=this.getMousePosition(a);this.dispatchMouseEvent("mouseout",0,b.x,b.y,a,this.xml3dElem);return!1};b.prototype.mouseWheel=function(a){var b=this.getMousePosition(a);this.dispatchMouseEvent("mousewheel",0,b.x,b.y,a,this.xml3dElem);return!1};b.prototype.dispatchFrameDrawnEvent=function(a,b,d){var e=document.createEvent("CustomEvent");e.initCustomEvent("framedrawn",!0,!0,{timeStart:a,timeEnd:b,
renderTimeInMilliseconds:b-a,numberOfObjectsDrawn:d[0],numberOfTrianglesDrawn:Math.floor(d[1])});this.xml3dElem.dispatchEvent(e)};b.prototype.shutdown=function(){this.renderer&&this.renderer.dispose()};b.prototype.getMousePosition=function(a){var b=this.canvas.getBoundingClientRect();return{x:a.clientX-b.left,y:a.clientY-b.top}};b.prototype.setMouseMovePicking=function(a){this.mouseMovePickingEnabled=a};XML3D.webgl.CanvasHandler=b})();
XML3D.webgl.createCanvas=function(b){var a=b.parentNode,c=a.ownerDocument.createElement("div");c.style.display="none";a.insertBefore(c,b);c.appendChild(b);var d=b._configured.canvas;a.insertBefore(d,c);b=d.ownerDocument.defaultView.getComputedStyle(b);if(!d.style.backgroundColor&&(b=b.getPropertyValue("background-color"))&&"transparent"!=b)d.style.backgroundColor=b;d.width=d.clientWidth;d.height=d.clientHeight;return d};
XML3D.webgl.stopEvent=function(b){b.preventDefault&&b.preventDefault();b.stopPropagation&&b.stopPropagation();b.returnValue=!1};(function(){var b=new Float32Array(6);XML3D.webgl.calculateBoundingBox=function(a,d){var e=new window.XML3DBox;if(!a||3>a.length)return e;if(d){var f=3*d[0];b[0]=a[f];b[1]=a[f+1];b[2]=a[f+2];b[3]=a[f];b[4]=a[f+1];b[5]=a[f+2];for(f=1;f<d.length;f++){var g=3*d[f],h=a[g],i=a[g+1],g=a[g+2];h<b[0]&&(b[0]=h);i<b[1]&&(b[1]=i);g<b[2]&&(b[2]=g);h>b[3]&&(b[3]=h);i>b[4]&&(b[4]=i);g>b[5]&&(b[5]=g)}}else{b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[0];b[4]=a[1];b[5]=a[2];for(f=3;f<a.length;f+=3)a[f]<b[0]&&(b[0]=a[f]),
a[f+1]<b[1]&&(b[1]=a[f+1]),a[f+2]<b[2]&&(b[2]=a[f+2]),a[f]>b[3]&&(b[3]=a[f]),a[f+1]>b[4]&&(b[4]=a[f+1]),a[f+2]>b[5]&&(b[5]=a[f+2])}e.min.set(b[0],b[1],b[2]);e.max.set(b[3],b[4],b[5]);return e};var a=mat4.create();XML3D.webgl.transformAABB=function(b,d){if(!b.isEmpty()){var e=b.min._data,f=b.max._data,g=vec3.scale(vec3.add(e,f,vec3.create()),0.5),e=vec3.scale(vec3.subtract(f,e,vec3.create()),0.5);mat4.toRotationMat(d,a);for(f=0;16>f;f++)a[f]=Math.abs(a[f]);mat4.multiplyVec3(a,e);mat4.multiplyVec3(d,
g);vec3.add(g,e,b.max._data);vec3.subtract(g,e,b.min._data)}};XML3D.webgl.splitMesh=function(a,b){var b=3*Math.floor(b/3),e=a.position.data,f=a.index?a.index.data:void 0,g=a.normal?a.normal.data:void 0,h=a.texcoord?a.texcoord.data:void 0,i=a.color?a.color.data:void 0,j=a.position.tupleSize,k=a.texcoord?a.texcoord.tupleSize:void 0,m=f.length;if(f){for(var o=[],l=Math.ceil(m/b),m=[],n=0;n<l;n++)if(m[n]={},m[n].index=new Uint16Array(b),m[n].index.nextFreeSlot=0,m[n].position=new Float32Array(b*j),g&&
(m[n].normal=new Float32Array(b*j)),h&&(m[n].texcoord=new Float32Array(b*k)),i)m[n].color=new Float32Array(3*b);for(n=0;n<f.length;n+=3){var p=!0,l=Math.floor(f[n]/b);m[l].index.nextFreeSlot+3>b&&(p=!1);for(r=1;3>r;r++)if(Math.floor(f[n+r]/b)!=l){p=!1;break}if(p)for(var p=b*l,r=0;3>r;r++){var v=f[n+r],u=v-p,t=m[l];t.index[t.index.nextFreeSlot]=u;t.index.nextFreeSlot++;for(var x=v*j,s=[],q=0;q<j;q++)s[q]=e[x+q];t.position.set(s,u*j);if(g){s=[];for(q=0;q<j;q++)s[q]=g[x+q];t.normal.set(s,u*j)}v*=k;if(h){s=
[];for(q=0;q<k;q++)s[q]=h[v+q];t.texcoord.set(s,u*k)}if(i){s=[];for(q=0;3>q;q++)s[q]=i[x+q];t.color.set(s,3*u)}}else o.push(n)}for(n=l=0;n<o.length;n++){for(;m[l].index.nextFreeSlot+3>b;)if(l++,l>=m.length){m[l]={};m[l].index=new Uint16Array(b);m[l].index.nextFreeSlot=0;m[l].position=new Float32Array(b*j);g&&(m[l].normal=new Float32Array(b*j));h&&(m[l].texcoord=new Float32Array(b*k));i&&(m[l].color=new Float32Array(3*b));break}for(r=0;3>r;r++){t=m[l];v=f[o[n]+r];u=t.index.nextFreeSlot;t.index[u]=
u;t.index.nextFreeSlot++;s=[];for(q=0;q<j;q++)s[q]=e[v*j+q];t.position.set(s,u*j);if(g){s=[];for(q=0;q<j;q++)s[q]=g[v*j+q];t.normal.set(s,u*j)}if(h){s=[];for(q=0;q<k;q++)s[q]=h[v*k+q];t.texcoord.set(s,u*k)}if(i){s=[];for(q=0;q<j;q++)s[q]=i[3*v+q];t.color.set(s,3*u)}}}a.index=[];a.position=[];g&&(a.normal=[]);h&&(a.texcoord=[]);i&&(a.color=[]);for(n=0;n<m.length;n++)0<m[n].index.nextFreeSlot&&(a.index[n]={data:m[n].index,tupleSize:j},a.position[n]={data:m[n].position,tupleSize:j},g&&(a.normal[n]={data:m[n].normal,
tupleSize:j}),h&&(a.texcoord[n]={data:m[n].texcoord,tupleSize:k}),i&&(a.color[n]={data:m[n].color,tupleSize:3}))}}})();XML3D.webgl.XML3DShaderManager=function(b,a,c,d){this.gl=b;this.renderer=a;this.dataFactory=c;this.factory=d;this.currentProgram=null;this.shaders={};a=this.getStandardShaderProgram("matte");a.hasTransparency=!1;this.bindShader(a);this.setUniform(b,a.uniforms.diffuseColor,[1,0,0]);this.unbindShader(a);this.shaders.defaultShader=a;this.shaders.picking=this.getStandardShaderProgram("picking");this.shaders.pickedNormals=this.getStandardShaderProgram("pickedNormals")};
XML3D.webgl.XML3DShaderManager.prototype.createShader=function(b,a){var c=null,d="defaultShader",e=null;b&&(e=b.node,d=e.id);if(c=this.shaders[d])return d;var c={vertex:null,fragment:null},f=null,g=!1,h=!1;b&&(f=b.getDataTable(),g=this.hasTextures(f),f.transparency&&(h=0<f.transparency.data[0]));e&&e.hasAttribute("script")?(e=e.getAttribute("script"),"urn"==(new XML3D.URI(e)).scheme?c=this.getStandardShaderSource(e,b,a,g):(g=XML3D.URIResolver.resolve(e+"-vs"),e=XML3D.URIResolver.resolve(e+"-fs"),
g&&e&&(c.vertex=g.textContent,c.fragment=e.textContent)),c=this.createShaderFromSources(c),c.hasTransparency=h,this.shaders[d]=c):(c=this.shaders.defaultShader,d="defaultShader");b&&(this.createTextures(c,f)?this.setUniformVariables(c,f):(this.destroyShader(c),d="defaultShader"));return d};
XML3D.webgl.XML3DShaderManager.prototype.getStandardShaderSource=function(b,a,c,d){var e={vertex:null,fragment:null},b=b.substring(b.lastIndexOf(":")+1),a=a.getDataTable();if(d&&("phong"==b||"diffuse"==b))b="textured"+b;a.useVertexColor&&!0==a.useVertexColor.data[0]&&(b+="vcolor");switch(b){case "phong":case "texturedphong":case "phongvcolor":case "diffuse":case "textureddiffuse":case "diffusevcolor":e=XML3D.shaders.getScript(b);e.fragment="#define MAXLIGHTS "+c.length.toString()+"\n"+e.fragment;
break;default:e=XML3D.shaders.getScript(b)}return e};XML3D.webgl.XML3DShaderManager.prototype.getStandardShaderProgram=function(b){var a={},a=XML3D.shaders.getScript(b);if(!a||!a.vertex)a={},XML3D.debug.logError("Unknown shader: "+b+". Using flat shader instead.");return this.createShaderFromSources(a)};
XML3D.webgl.XML3DShaderManager.prototype.createShaderFromSources=function(b){var a=this.gl;if(!b.vertex||!b.fragment)return this.shaders.defaultShader;var c=a.createProgram(),d=this.compileShader(a.VERTEX_SHADER,b.vertex),e=this.compileShader(a.FRAGMENT_SHADER,b.fragment);if(null===d||null===e)return this.shaders.defaultShader;a.attachShader(c,d);a.attachShader(c,e);a.linkProgram(c);if(0==a.getProgramParameter(c,a.LINK_STATUS))return c="Shader linking failed: \n"+a.getProgramInfoLog(c),XML3D.debug.logError(c+
"\n--------\n"),a.getError(),this.shaders.defaultShaders;b={attributes:{},uniforms:{},samplers:{},handle:c,vSource:b.vs,fSource:b.fs};a.useProgram(c);e=a.getProgramParameter(c,a.ACTIVE_ATTRIBUTES);for(d=0;d<e;d++){var f=a.getActiveAttrib(c,d);if(f){var g={};g.name=f.name;g.size=f.size;g.glType=f.type;g.location=a.getAttribLocation(c,f.name);b.attributes[f.name]=g}}e=0;f=a.getProgramParameter(c,a.ACTIVE_UNIFORMS);for(d=0;d<f;d++)if(g=a.getActiveUniform(c,d)){var h={};h.name=g.name;h.size=g.size;h.glType=
g.type;h.location=a.getUniformLocation(c,g.name);g.type==a.SAMPLER_2D||g.type==a.SAMPLER_CUBE?(h.texUnit=e,b.samplers[g.name]=h,e++):b.uniforms[g.name]=h}this.setStandardUniforms(b);b.changes=[];return b};
XML3D.webgl.XML3DShaderManager.prototype.compileShader=function(b,a){var c=this.gl,d=c.createShader(b);c.shaderSource(d,a);c.compileShader(d);if(0==c.getShaderParameter(d,c.COMPILE_STATUS)){var e="",e=b==c.VERTEX_SHADER?"Vertex shader failed to compile: \n":"Fragment shader failed to compile: \n",e=e+(c.getShaderInfoLog(d)+"\n--------\n");XML3D.debug.logError(e);c.getError();return null}return d};
XML3D.webgl.XML3DShaderManager.prototype.recompileShader=function(b,a){var c=b.node.id,d=this.shaders[c];d&&(this.destroyShader(d),delete this.shaders[c],this.createShader(b,a))};XML3D.webgl.XML3DShaderManager.prototype.shaderDataChanged=function(b,a,c,d){b=this.shaders[b];"src"==a?d?(a=b.samplers[d])&&this.replaceTexture(a,c):XML3D.debug.logError("Couldn't apply change because of a missing texture name"):("transparency"==a&&(b.hasTransparency=0<c),b.changes.push({type:"uniform",name:a,newValue:c}))};
XML3D.webgl.XML3DShaderManager.prototype.setStandardUniforms=function(b){var a=this.gl,c=null;(c=b.uniforms.diffuseColor)&&this.setUniform(a,c,[1,1,1]);(c=b.uniforms.emissiveColor)&&this.setUniform(a,c,[0,0,0]);(c=b.uniforms.specularColor)&&this.setUniform(a,c,[0,0,0]);(c=b.uniforms.shininess)&&this.setUniform(a,c,0.2);(c=b.uniforms.transparency)&&this.setUniform(a,c,0)};
XML3D.webgl.XML3DShaderManager.prototype.getShaderById=function(b){var a=this.shaders[b];if(!a){if(a=this.factory.getAdapter(document.getElementById(b)))if(this.createShader(a,this.renderer.lights),this.shaders[b])return this.shaders[b];XML3D.debug.logError("Could not find the shader [ "+b+" ]");a=this.shaders["default"]}return a};
XML3D.webgl.XML3DShaderManager.prototype.setUniformVariables=function(b,a){this.bindShader(b);for(var c in a){var d=a[c];d.data&&(d=d.data);d.clean||(1==d.length&&(d=d[0]),b.uniforms[c]&&this.setUniform(this.gl,b.uniforms[c],d))}};XML3D.webgl.XML3DShaderManager.prototype.bindShader=function(b){b="string"==typeof b?this.getShaderById(b):b;this.currentProgram!=b.handle&&(this.currentProgram=b.handle,this.gl.useProgram(b.handle));var b=b.samplers,a;for(a in b)this.bindTexture(b[a])};
XML3D.webgl.XML3DShaderManager.prototype.updateShader=function(b){for(var a=0,c=b.changes.length;a<c;a++){var d=b.changes[a];"uniform"==d.type&&b.uniforms[d.name]&&this.setUniform(this.gl,b.uniforms[d.name],d.newValue)}b.changes=[]};XML3D.webgl.XML3DShaderManager.prototype.unbindShader=function(b){var b=("string"==typeof b?this.getShaderById(b):b).samplers,a;for(a in b)this.unbindTexture(b[a]);this.currentProgram=null;this.gl.useProgram(null)};
XML3D.webgl.XML3DShaderManager.prototype.setUniform=function(b,a,c){switch(a.glType){case 35670:case 5124:case 35678:b.uniform1i(a.location,c);break;case 35671:case 35667:b.uniform2iv(a.location,c);break;case 35672:case 35668:b.uniform3iv(a.location,c);break;case 35673:case 35669:b.uniform4iv(a.location,c);break;case 5126:b.uniform1f(a.location,c);break;case 35664:b.uniform2fv(a.location,c);break;case 35665:b.uniform3fv(a.location,c);break;case 35666:b.uniform4fv(a.location,c);break;case 35674:b.uniformMatrix2fv(a.location,
b.FALSE,c);break;case 35675:b.uniformMatrix3fv(a.location,b.FALSE,c);break;case 35676:b.uniformMatrix4fv(a.location,b.FALSE,c);break;default:XML3D.debug.logError("Unknown uniform type "+a.glType)}};XML3D.webgl.XML3DShaderManager.prototype.setGLContext=function(b){this.gl=b};XML3D.webgl.XML3DShaderManager.prototype.destroyShader=function(b){for(var a in b.samplers)this.destroyTexture(b.samplers[a]);this.gl.deleteProgram(b.handle)};
XML3D.webgl.XML3DShaderManager.prototype.hasTextures=function(b){for(var a in b)if(b[a].isTexture)return!0;return!1};
XML3D.webgl.XML3DShaderManager.prototype.createTextures=function(b,a){var c=0,d;for(d in b.samplers){var e=a[d];if(!e)return XML3D.debug.logWarning("Can't find required texture with name='"+d+"'. Using default shader instead."),!1;var f=b.samplers[d],g=a[d].options,g={isDepth:!1,minFilter:g.minFilter,magFilter:g.magFilter,wrapS:g.wrapS,wrapT:g.wrapT,generateMipmap:g.generateMipmap,flipY:!0,premultiplyAlpha:!0},h=this.gl.createTexture(),e=this.loadImage(e.src[0]);e.texUnit=c;e.handle=h;f.info=e;f.options=
g;c++}return!0};XML3D.webgl.XML3DShaderManager.prototype.loadImage=function(b){var a={status:0},c=new Image,d=this.renderer;c.onload=function(){a.status=1;d.requestRedraw.call(d,"Texture loaded")};c.src=b;a.image=c;return a};XML3D.webgl.XML3DShaderManager.prototype.replaceTexture=function(b,a){this.destroyTexture(b);var c=this.gl.createTexture(),d=this.loadImage(a);d.handle=c;c=b.info;d.format=c.format;d.glType=c.glType;d.options=c.options;d.valid=!1;b.info=d};
XML3D.webgl.XML3DShaderManager.prototype.createTex2DFromData=function(b,a,c,d,e,f,g){var h=this.gl,i={};f||(f=e==h.FLOAT?new Float32Array(4*a*c):new Uint8Array(4*a*c));var j=h.createTexture();h.bindTexture(h.TEXTURE_2D,j);h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,g.wrapS);h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,g.wrapT);h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,g.minFilter);h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,g.magFilter);h.texImage2D(h.TEXTURE_2D,0,b,a,c,0,d,e,f);
g.isDepth&&(h.texParameteri(h.TEXTURE_2D,h.DEPTH_TEXTURE_MODE,g.depthMode),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_COMPARE_MODE,g.depthCompareMode),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_COMPARE_FUNC,g.depthCompareFunc));g.generateMipmap&&h.generateMipmap(h.TEXTURE_2D);h.bindTexture(h.TEXTURE_2D,null);i.handle=j;i.options=g;i.valid=!0;i.glType=h.TEXTURE_2D;i.format=b;return i};
XML3D.webgl.XML3DShaderManager.prototype.createTex2DFromImage=function(b,a){var c=this.gl,d={},e=b.image;c.bindTexture(c.TEXTURE_2D,b.handle);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,a.wrapS);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,a.wrapT);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,a.minFilter);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,a.magFilter);if(!this.isPowerOfTwo(e.width)||!this.isPowerOfTwo(e.height)){var f=document.createElement("canvas");f.width=this.nextHighestPowerOfTwo(e.width);
f.height=this.nextHighestPowerOfTwo(e.height);f.getContext("2d").drawImage(e,0,0,f.width,f.height);e=f}c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,e);a.generateMipmap&&c.generateMipmap(c.TEXTURE_2D);c.bindTexture(c.TEXTURE_2D,null);d.handle=b.handle;d.texUnit=b.texUnit;d.options=a;d.valid=!0;d.glType=c.TEXTURE_2D;d.format=c.RGBA;return d};
XML3D.webgl.XML3DShaderManager.prototype.bindTexture=function(b){var a=b.info;a.valid?(this.gl.activeTexture(this.gl.TEXTURE0+a.texUnit),this.gl.bindTexture(a.glType,a.handle)):a.status&&(b.info=this.createTex2DFromImage(a,b.options))};XML3D.webgl.XML3DShaderManager.prototype.unbindTexture=function(b){this.gl.activeTexture(this.gl.TEXTURE0+b.info.texUnit);this.gl.bindTexture(b.info.glType,null)};XML3D.webgl.XML3DShaderManager.prototype.destroyTexture=function(b){b.info&&b.info.handle&&this.gl.deleteTexture(b.info.handle)};
XML3D.webgl.XML3DShaderManager.prototype.isPowerOfTwo=function(b){return 0==(b&b-1)};XML3D.webgl.XML3DShaderManager.prototype.nextHighestPowerOfTwo=function(b){--b;for(var a=1;32>a;a<<=1)b|=b>>a;return b+1};XML3D.webgl.MAX_PICK_BUFFER_WIDTH=512;XML3D.webgl.MAX_PICK_BUFFER_HEIGHT=512;XML3D.webgl.XML3DBufferHandler=function(b,a,c){this.renderer=a;this.gl=b;this.shaderManager=c};
XML3D.webgl.XML3DBufferHandler.prototype.createPickingBuffer=function(b,a){var c=this.gl,d=1,e=a-XML3D.webgl.MAX_PICK_BUFFER_HEIGHT,f=b-XML3D.webgl.MAX_PICK_BUFFER_WIDTH;if(0<e||0<f)d=e>f?XML3D.webgl.MAX_PICK_BUFFER_HEIGHT/a:XML3D.webgl.MAX_PICK_BUFFER_WIDTH/b;b=Math.floor(b*d);a=Math.floor(a*d);return this.createFrameBuffer(b,a,c.RGBA,c.DEPTH_COMPONENT16,null,{depthAsRenderbuffer:!0},d)};XML3D.webgl.XML3DBufferHandler.prototype.createShadowBuffer=function(){};
XML3D.webgl.XML3DBufferHandler.prototype.createFrameBuffer=function(b,a,c,d,e,f,g){var h=this.gl,f=this.fillOptions(f),i=h.createFramebuffer();h.bindFramebuffer(h.FRAMEBUFFER,i);var j={handle:null,isTexture:!1};if(c)if(f.colorAsRenderbuffer){var k=h.createRenderbuffer();h.bindRenderbuffer(h.RENDERBUFFER,k);h.renderbufferStorage(h.RENDERBUFFER,c,b,a);h.bindRenderbuffer(h.RENDERBUFFER,null);h.framebufferRenderbuffer(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.RENDERBUFFER,k);j.handle=k;j.isTexture=!1}else c=
this.shaderManager.createTex2DFromData(c,b,a,h.RGBA,h.UNSIGNED_BYTE,null,f),h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_2D,c.handle,0),j.handle=i,j.isTexture=!0;c={handle:null,isTexture:!1};d&&(f.isDepth=!0,f.depthAsRenderbuffer?(k=h.createRenderbuffer(),h.bindRenderbuffer(h.RENDERBUFFER,k),h.renderbufferStorage(h.RENDERBUFFER,d,b,a),h.bindRenderbuffer(h.RENDERBUFFER,null),h.framebufferRenderbuffer(h.FRAMEBUFFER,h.DEPTH_ATTACHMENT,h.RENDERBUFFER,k),c.handle=k,c.isTexture=!1):
(d=this.shaderManager.createTex2DFromData(d,b,a,h.DEPTH_COMPONENT,h.FLOAT,null,f),h.framebufferTexture2D(h.FRAMEBUFFER,h.DEPTH_ATTACHMENT,h.TEXTURE_2D,d.handle,0),c.handle=d.handle,c.isTexture=!0));d={handle:null,isTexture:!1};e&&(f.isDepth=!1,f.stencilAsRenderbuffer?(f=h.createRenderbuffer(),h.bindRenderbuffer(h.RENDERBUFFER,f),h.renderbufferStorage(h.RENDERBUFFER,e,b,a),h.bindRenderbuffer(h.RENDERBUFFER,null),h.framebufferRenderbuffer(h.FRAMEBUFFER,h.STENCIL_ATTACHMENT,h.RENDERBUFFER,f),d.handle=
f,d.isTexture=!1):(e=this.shaderManager.createTex2DFromData(e,b,a,h.STENCIL_COMPONENT,h.UNSIGNED_BYTE,null,f),h.framebufferTexture2D(h.FRAMEBUFFER,h.STENCIL_ATTACHMENT,h.TEXTURE_2D,e.handle,0),d.handle=e.handle,d.isTexture=!0));e=h.checkFramebufferStatus(h.FRAMEBUFFER);switch(e){case h.FRAMEBUFFER_COMPLETE:break;case h.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:XML3D.debug.logError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case h.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:XML3D.debug.logError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");
break;case h.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:XML3D.debug.logError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case h.FRAMEBUFFER_UNSUPPORTED:XML3D.debug.logError("Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");break;default:XML3D.debug.logError("Incomplete framebuffer: "+e)}h.bindFramebuffer(h.FRAMEBUFFER,null);f={};f.handle=i;f.valid=e==h.FRAMEBUFFER_COMPLETE;f.width=b;f.height=a;f.colorTarget=j;f.depthTarget=c;f.stencilTarget=d;f.scale=g;return f};
XML3D.webgl.XML3DBufferHandler.prototype.destroyFrameBuffer=function(b){if(b.handle){var a=this.gl;a.deleteFramebuffer(b.handle);null!==b.colorTarget&&(b.colorTarget.isTexture?a.deleteTexture(b.colorTarget.handle):a.deleteRenderBuffer(b.colorTarget.handle));null!==b.depthTarget&&(b.depthTarget.isTexture?a.deleteTexture(b.depthTarget.handle):a.deleteRenderBuffer(b.depthTarget.handle));null!==b.stencilTarget&&(b.stencilTarget.isTexture?a.deleteTexture(b.stencilTarget.handle):a.deleteRenderBuffer(b.stencilTarget.handle))}};
XML3D.webgl.XML3DBufferHandler.prototype.fillOptions=function(b){var a=this.gl,a={wrapS:a.CLAMP_TO_EDGE,wrapT:a.CLAMP_TO_EDGE,minFilter:a.NEAREST,magFilter:a.NEAREST,depthMode:a.LUMINANCE,depthCompareMode:a.COMPARE_R_TO_TEXTURE,depthCompareFunc:a.LEQUAL,colorsAsRenderbuffer:!1,depthAsRenderbuffer:!1,stencilAsRenderbuffer:!1,isDepth:!1},c;for(c in b)a[c]=b[c];return a};(function(){var b=document.createElement("canvas");XML3D.webgl.supported=function(){try{return!(!window.WebGLRenderingContext||!b.getContext("experimental-webgl"))}catch(a){return!1}};XML3D.webgl.configure=function(a){for(var b in a){var c=XML3D.webgl.createCanvas(a[b],b);(new XML3D.webgl.CanvasHandler(c,a[b])).start()}};XML3D.webgl.checkError=function(a,b){var c=a.getError();if(c!==a.NO_ERROR){var d=""+c;switch(c){case 1280:d="1280 ( GL_INVALID_ENUM )";break;case 1281:d="1281 ( GL_INVALID_VALUE )";
break;case 1282:d="1282 ( GL_INVALID_OPERATION )";break;case 1283:d="1283 ( GL_STACK_OVERFLOW )";break;case 1284:d="1284 ( GL_STACK_UNDERFLOW )";break;case 1285:d="1285 ( GL_OUT_OF_MEMORY )"}c="GL error "+d+" occured.";void 0!==b&&(c+=" "+b);XML3D.debug.logError(c)}};XML3D.webgl.Renderer=function(a,b,c){this.handler=a;this.currentView=null;this.xml3dNode=a.xml3dElem;this.factory=new XML3D.webgl.XML3DRenderAdapterFactory(a,this);this.dataFactory=new XML3D.webgl.XML3DDataAdapterFactory(a);this.shaderManager=
new XML3D.webgl.XML3DShaderManager(a.gl,this,this.dataFactory,this.factory);this.bufferHandler=new XML3D.webgl.XML3DBufferHandler(a.gl,this,this.shaderManager);this.camera=this.initCamera();this.width=b;this.height=c;this.fbos=this.initFrameBuffers(a.gl);this.lights=[];this.drawableObjects=[];this.recursiveBuildScene(this.drawableObjects,this.xml3dNode,!0,mat4.identity(mat4.create()),null);1>this.lights.length&&XML3D.debug.logWarning("No lights were found. The scene will be rendered without lighting!");
this.processShaders(this.drawableObjects)};XML3D.webgl.Renderer.drawableObject=function(){this.transform=this.shader=this.mesh=null;this.visible=!0;this.meshNode=null;var a=this;this.getObject=function(){return a}};XML3D.webgl.Renderer.prototype.initCamera=function(){var a=this.xml3dNode.activeView,b=null;""!=a&&(b=XML3D.URIResolver.resolve(a));if(null==b)return b=document.evaluate(".//xml3d:view[1]",this.xml3dNode,function(){return XML3D.xml3dNS},XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,
null==b&&XML3D.debug.logError("No view defined."),this.currentView=b,this.factory.getAdapter(b);this.currentView=b;return this.factory.getAdapter(b)};XML3D.webgl.Renderer.prototype.processShaders=function(a){for(var b=0,c=a.length;b<c;b++){var d=a[b],e=this.factory.getAdapter(d.meshNode.parentNode),e=this.shaderManager.createShader(e?e.getShader():null,this.lights);d.shader=e}};XML3D.webgl.Renderer.prototype.recursiveBuildScene=function(a,b,c,d,e){var f=this.factory.getAdapter(b),o=e,l=d;switch(b.nodeName){case "group":c=
(f.parentVisible=c)&&b.visible;(b.onmouseover||b.onmouseout)&&this.handler.setMouseMovePicking(!0);o=(o=f.getShader())?o:e;f.parentTransform=d;f.parentShader=e;f.isVisible=c;l=f.applyTransformMatrix(mat4.identity(mat4.create()));break;case "mesh":(b.onmouseover||b.onmouseout)&&this.handler.setMouseMovePicking(!0);e=this.factory.getAdapter(b);if(!e)break;f.parentVisible=c;var n=new XML3D.webgl.Renderer.drawableObject;n.mesh=e.createMesh(this.handler.gl);n.meshNode=b;n.visible=c&&b.visible;n.shader=
null;n.transform=d;f.registerCallback(n.getObject);a.push(n);break;case "light":this.lights.push({adapter:f,transform:d});f.transform=d;f.visible=c&&b.visible;break;case "view":f.parentTransform=d,f.updateViewMatrix()}for(b=b.firstElementChild;b;)this.recursiveBuildScene(a,b,c,l,o),b=b.nextSibling};XML3D.webgl.Renderer.prototype.initFrameBuffers=function(){var a={};a.picking=this.bufferHandler.createPickingBuffer(this.width,this.height);a.picking.valid||(this.handler._pickingDisabled=!0);return a};
XML3D.webgl.Renderer.prototype.getGLContext=function(){return this.handler.gl};XML3D.webgl.Renderer.prototype.recompileShader=function(a){this.shaderManager.recompileShader(a,this.lights);this.handler.redraw("A shader was recompiled")};XML3D.webgl.Renderer.prototype.shaderDataChanged=function(a,b,c,d){this.shaderManager.shaderDataChanged(a,b,c,d);"src"!=b&&this.handler.redraw("A shader parameter was changed")};XML3D.webgl.Renderer.prototype.removeDrawableObject=function(a){this.drawableObjects.splice(this.drawableObjects.indexOf(a),
1)};XML3D.webgl.Renderer.prototype.setGLContext=function(a){this.shaderManager.setGLContext(a);this.meshManager.setGLContext(a)};XML3D.webgl.Renderer.prototype.resizeCanvas=function(a,b){this.width=a;this.height=b};XML3D.webgl.Renderer.prototype.activeViewChanged=function(){this._viewMatrix=this._projMatrix=null;this.camera=this.initCamera();this.requestRedraw("Active view changed",!0)};XML3D.webgl.Renderer.prototype.requestRedraw=function(a,b){this.handler.redraw(a,b)};XML3D.webgl.Renderer.prototype.sceneTreeAddition=
function(a){var b=this.factory.getAdapter(a.wrapped.target);if(b){var c=mat4.identity(mat4.create()),d=!0,e=null;b.getShader&&(e=b.getShader());var f=a.wrapped.target;for(b.isValid=!0;f.parentElement;)if(f=f.parentElement,"group"==f.nodeName)b=this.factory.getAdapter(f),c=b.applyTransformMatrix(c),e||(e=b.getShader()),"false"==f.getAttribute("visible")&&(d=!1);else break;f=[];this.recursiveBuildScene(f,a.wrapped.target,d,c,e);this.processShaders(f);this.drawableObjects=this.drawableObjects.concat(f);
this.requestRedraw("A node was added.")}};XML3D.webgl.Renderer.prototype.sceneTreeRemoval=function(a){(a=this.factory.getAdapter(a.wrapped.target))&&a.destroy&&a.destroy();this.requestRedraw("A node was removed.")};XML3D.webgl.Renderer.prototype.render=function(){var a=this.handler.gl;a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT|a.STENCIL_BUFFER_BIT);a.viewport(0,0,this.width,this.height);a.enable(a.DEPTH_TEST);if(!this.camera)return[0,0];var b={};b.view=this.camera.viewMatrix;b.proj=this.camera.getProjectionMatrix(this.width/
this.height);for(var c,d=this.lights,e=3*d.length,e={positions:new Float32Array(e),diffuseColors:new Float32Array(e),ambientColors:new Float32Array(e),attenuations:new Float32Array(e),visible:new Float32Array(e)},f=0,o=d.length;f<o;f++)if(c=d[f].adapter,c=c.getParameters(b.view))e.positions.set(c.position,3*f),e.attenuations.set(c.attenuation,3*f),e.diffuseColors.set(c.intensity,3*f),e.visible.set(c.visibility,3*f);d={objCount:0,triCount:0};c={};f=[];this.sortObjects(this.drawableObjects,c,f,b);a.blendFunc(a.SRC_ALPHA,
a.ONE_MINUS_SRC_ALPHA);for(var l in c)o=c[l],this.drawObjects(o,l,b,e,d);if(0<f.length){a.enable(a.BLEND);for(l=0;l<f.length;l++)o=[f[l]],this.drawObjects(o,o[0].shader,b,e,d);a.disable(a.BLEND)}return[d.objCount,d.triCount]};XML3D.webgl.Renderer.prototype.sortObjects=function(a,b,c,d,e){for(var f=[],o=0,l=a.length;o<l;o++){var n=a[o],p=n.shader;this.shaderManager.getShaderById(p).hasTransparency?f.push(n):(b[p]=b[p]||[],b[p].push(n))}a=f.length;if(1<a){for(o=0;o<a;o++)n=f[o],b=n.transform,l=n.mesh.bbox.center()._data,
l=mat4.multiplyVec4(b,quat4.create([l[0],l[1],l[2],1])),l=mat4.multiplyVec4(d.view,quat4.create([l[0],l[1],l[2],1])),f[o]=[n,l[3]];e?f.sort(function(a,b){return a[1]-b[1]}):f.sort(function(a,b){return b[1]-a[1]});for(o=0;o<a;o++)c[o]=f[o][0]}else 1==a&&(c[0]=f[0])};var a=mat4.create(),c=mat4.create(),d=mat3.identity(mat3.create());XML3D.webgl.Renderer.prototype.drawObjects=function(b,e,f,j,k){var m=0,o=0,l={};l["lightPositions[0]"]=j.positions;l["lightVisibility[0]"]=j.visible;l["lightDiffuseColors[0]"]=
j.diffuseColors;l["lightAmbientColors[0]"]=j.ambientColors;l["lightAttenuations[0]"]=j.attenuations;e=e||b[0].shader||"defaultShader";e=this.shaderManager.getShaderById(e);this.shaderManager.bindShader(e);this.shaderManager.updateShader(e);for(var j=0,n=b.length;j<n;j++){var p=b[j],r=p.mesh;!1!=p.visible&&(f.model=p.transform,f.modelView=mat4.multiply(this.camera.viewMatrix,f.model,a),l.modelMatrix=f.model,l.modelViewMatrix=f.modelView,l.modelViewProjectionMatrix=mat4.multiply(this.camera.projMatrix,
f.modelView,c),p=mat4.toInverseMat3(f.modelView),l.normalMatrix=p?mat3.transpose(p):d,this.shaderManager.setUniformVariables(e,l),o+=this.drawObject(e,r),m++)}k.objCount+=m;k.triCount+=o};XML3D.webgl.Renderer.prototype.drawObject=function(a,b){for(var c=a.attributes,e=this.handler.gl,d=0,f=b.vbos,o=b.isIndexed?f.index.length:f.position.length,l=0;l<o;l++){for(var n in c){var p=c[n];f[n]?(d=1<f[n].length?f[n][l]:f[n][0],e.enableVertexAttribArray(p.location),e.bindBuffer(e.ARRAY_BUFFER,d),e.vertexAttribPointer(p.location,
d.tupleSize,d.glType,!1,0,0)):XML3D.debug.logWarning("Missing required mesh data [ "+n+" ], the object may not render correctly.")}if(b.isIndexed){e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,f.index[l]);if(b.segments)for(var p=0,d=b.segments.data,r=0;r<d.length;r++)e.drawElements(b.glType,d[r],e.UNSIGNED_SHORT,p),p+=2*d[r];else e.drawElements(b.glType,f.index[l].length,e.UNSIGNED_SHORT,0);d=f.index[l].length/3}else{if(b.size){p=0;d=b.size.data;for(r=0;r<d.length;r++)e.drawArrays(b.glType,p,d[r]),p+=2*d[r]}else e.drawArrays(b.glType,
0,f.position[l].length);d=f.position[l].length/3}for(n in c)p=c[n],e.disableVertexAttribArray(p.location)}e.bindBuffer(e.ARRAY_BUFFER,null);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);return d};XML3D.webgl.Renderer.prototype.renderPickingPass=function(a,b,c){if(!(0>a||0>b||a>=this.width||b>=this.height)){var e=this.handler.gl,d=this.fbos.picking;e.bindFramebuffer(e.FRAMEBUFFER,d.handle);e.enable(e.DEPTH_TEST);e.disable(e.CULL_FACE);e.disable(e.BLEND);if(c){var f=(new window.XML3DVec3(-Number.MAX_VALUE,
-Number.MAX_VALUE,-Number.MAX_VALUE))._data,o=(new window.XML3DVec3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE))._data;e.viewport(0,0,d.width,d.height);e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT);var l;this.camera.getProjectionMatrix(this.width/this.height);for(d=0;d<this.drawableObjects.length;d++)c=this.drawableObjects[d],c.mesh.valid&&this.adjustMinMax(c.mesh.bbox,o,f,c.transform);this.bbMin=o;this.bbMax=f;d=this.shaderManager.getShaderById("picking");this.shaderManager.bindShader(d);
for(var f={min:o,max:f},o=0,n=this.drawableObjects.length;o<n;o++){var c=this.drawableObjects[o],p=c.transform,c=c.mesh;c.valid&&(l=p,l=this.camera.getModelViewMatrix(l),f.id=1-(1+o)/255,f.modelMatrix=p,f.modelViewProjectionMatrix=this.camera.getModelViewProjectionMatrix(l),this.shaderManager.setUniformVariables(d,f),this.drawObject(d,c))}this.shaderManager.unbindShader(d)}this.readPixels(!1,a,b);e.disable(e.DEPTH_TEST);e.bindFramebuffer(e.FRAMEBUFFER,null)}};XML3D.webgl.Renderer.prototype.renderPickedNormals=
function(a,b,c){var e=this.handler.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.fbos.picking.handle);e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT);e.enable(e.DEPTH_TEST);e.disable(e.CULL_FACE);e.disable(e.BLEND);var d=a.transform,a=a.mesh,f=this.shaderManager.getShaderById("pickedNormals");this.shaderManager.bindShader(f);var o;o=this.camera.getModelViewMatrix(d);d={modelViewMatrix:d,modelViewProjectionMatrix:this.camera.getModelViewProjectionMatrix(o),normalMatrix:this.camera.getNormalMatrix(o)};
this.shaderManager.setUniformVariables(f,d);this.drawObject(f,a);this.shaderManager.unbindShader(f);this.readPixels(!0,b,c);e.bindFramebuffer(e.FRAMEBUFFER,null);this.handler.needPickingDraw=!0};var e=vec3.create(),f=new Uint8Array(8);XML3D.webgl.Renderer.prototype.readPixels=function(a,b,c){var d=this.fbos.picking.scale,k=this.handler.gl;try{if(k.readPixels(b*d,c*d,1,1,k.RGBA,k.UNSIGNED_BYTE,f),e[0]=f[0]/255,e[1]=f[1]/255,e[2]=f[2]/255,a)e=vec3.subtract(vec3.scale(e,2),vec3.create([1,1,1])),this.xml3dNode.currentPickNormal=
e;else{var m=255-f[3]-1;if(0<=m&&0<f[3]){var o=vec3.subtract(this.bbMax,this.bbMin,vec3.create());e=vec3.create([e[0]*o[0],e[1]*o[1],e[2]*o[2]]);vec3.add(e,this.bbMin,e);var l=this.drawableObjects[m];this.xml3dNode.currentPickPos=e;this.xml3dNode.currentPickObj=l.meshNode}else this.xml3dNode.currentPickPos=null,this.xml3dNode.currentPickObj=null}}catch(n){XML3D.debug.logError(n)}};XML3D.webgl.Renderer.prototype.adjustMinMax=function(a,b,c,e){var d=vec3.create(),f=vec3.create();mat4.multiplyVec3(e,
a.min._data,d);mat4.multiplyVec3(e,a.max._data,f);d[0]<b[0]&&(b[0]=d[0]);d[1]<b[1]&&(b[1]=d[1]);d[2]<b[2]&&(b[2]=d[2]);f[0]>c[0]&&(c[0]=f[0]);f[1]>c[1]&&(c[1]=f[1]);f[2]>c[2]&&(c[2]=f[2])};XML3D.webgl.Renderer.prototype.dispose=function(){for(var a=0,b=this.drawableObjects.length;a<b;a++){var c=this.drawableObjects[a][2];this.drawableObjects[a][1].dispose();c&&c.dispose()}};XML3D.webgl.Renderer.prototype.notifyDataChanged=function(){this.handler.redraw("Unspecified data change.")};XML3D.webgl.RenderAdapter=
function(a,b){XML3D.data.Adapter.call(this,a,b)};XML3D.webgl.RenderAdapter.prototype=new XML3D.data.Adapter;XML3D.webgl.RenderAdapter.prototype.constructor=XML3D.webgl.RenderAdapter;XML3D.webgl.RenderAdapter.prototype.isAdapterFor=function(a){return a==XML3D.webgl.Renderer.prototype};XML3D.webgl.RenderAdapter.prototype.getShader=function(){return null};XML3D.webgl.RenderAdapter.prototype.applyTransformMatrix=function(a){return a};XML3D.webgl.XML3DDefsRenderAdapter=function(a,b){XML3D.webgl.RenderAdapter.call(this,
a,b)};XML3D.webgl.XML3DDefsRenderAdapter.prototype=new XML3D.webgl.RenderAdapter;XML3D.webgl.XML3DDefsRenderAdapter.prototype.constructor=XML3D.webgl.XML3DDefsRenderAdapter;XML3D.webgl.XML3DDefsRenderAdapter.prototype.notifyChanged=function(){};XML3D.webgl.XML3DImgRenderAdapter=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.textureAdapter=a.getAdapter(b.parentNode)};XML3D.webgl.XML3DImgRenderAdapter.prototype=new XML3D.webgl.RenderAdapter;XML3D.webgl.XML3DImgRenderAdapter.prototype.constructor=
XML3D.webgl.XML3DImgRenderAdapter;XML3D.webgl.XML3DImgRenderAdapter.prototype.notifyChanged=function(a){this.textureAdapter.notifyChanged(a)};XML3D.webgl.XML3DLightShaderRenderAdapter=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b)};XML3D.webgl.XML3DLightShaderRenderAdapter.prototype=new XML3D.webgl.RenderAdapter;XML3D.webgl.XML3DLightShaderRenderAdapter.prototype.constructor=XML3D.webgl.XML3DLightShaderRenderAdapter})();(function(){var b=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.factory=a;this.processListeners()};XML3D.createClass(b,XML3D.webgl.RenderAdapter);b.prototype.notifyChanged=function(a){0==a.type?this.factory.renderer.sceneTreeAddition(a):2==a.type&&this.factory.renderer.sceneTreeRemoval(a);"activeView"==(a.internalType||a.attrName||a.wrapped.attrName)&&this.factory.renderer.activeViewChanged()};b.prototype.processListeners=function(){var a=this.node.attributes,b;for(b in a){var d=a[b];
if(d.name){var e=d.name;(e.match(/onmouse/)||"onclick"==e||"ondblclick"==e)&&this.node.addEventListener(e.substring(2),new Function("evt",d.value),!1)}}};b.prototype.getElementByPoint=function(a,b,d,e){this.factory.handler.renderPick(a,b);d&&this.node.currentPickPos&&XML3D.copyVector(d,this.node.currentPickPos);e&&this.node.currentPickObj&&(this.factory.handler.renderPickedNormals(this.node.currentPickObj,a,b),XML3D.copyVector(e,this.node.currentPickNormal));return this.node.currentPickObj?this.node.currentPickObj:
null};b.prototype.generateRay=function(a,b){var d=this.factory.handler.getCanvasHeight()-b-1;return this.factory.handler.generateRay(a,d)};XML3D.webgl.XML3DCanvasRenderAdapter=b})();(function(){var b=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.matrix=null;this.isValid=!0};XML3D.createClass(b,XML3D.webgl.RenderAdapter);var a=b.prototype;a.getMatrix=function(){if(!this.matrix){var a=this.node,b=mat4.identity(mat4.create()),e=a.translation._data,f=a.center._data,g=a.scale._data,h=a.scaleOrientation.toMatrix()._data,a=a.rotation.toMatrix()._data;this.matrix=mat4.multiply(mat4.multiply(mat4.multiply(mat4.multiply(mat4.multiply(mat4.multiply(mat4.translate(b,e,mat4.create()),
mat4.translate(b,f,mat4.create())),a),h),mat4.scale(b,g,mat4.create())),mat4.inverse(h,mat4.create())),mat4.translate(b,vec3.negate(f),mat4.create()))}return this.matrix};a.notifyChanged=function(a){1==a.type?(this.matrix=null,this.matrix=this.getMatrix(),this.factory.renderer.requestRedraw("Transformation changed.",!0)):2==a.type&&this.dispose();var b=this.node._configured.opposites;if(b)for(var e=0,f=b.length;e<f;e++){var g=this.factory.getAdapter(b[e].relatedNode);g&&g.notifyChanged&&g.notifyChanged(a)}};
a.dispose=function(){this.isValid=!1};XML3D.webgl.XML3DTransformRenderAdapter=b})();(function(){var b=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.zFar=1E5;this.zNear=0.1;this.parentTransform=null;this.viewMatrix=mat4.create();this.projMatrix=null;this.updateViewMatrix()};XML3D.createClass(b,XML3D.webgl.RenderAdapter);var a=b.prototype,c=mat4.create(),d=mat4.create();a.updateViewMatrix=function(){var a=this.node.position._data,b=this.node.orientation.toMatrix()._data;mat4.identity(c);c[12]=a[0];c[13]=a[1];c[14]=a[2];mat4.multiply(c,b);(this.parentTransform=this.factory.getAdapter(this.node.parentNode).applyTransformMatrix(mat4.identity(d)))&&
mat4.multiply(this.parentTransform,c,c);mat4.set(mat4.inverse(c),this.viewMatrix)};a.getProjectionMatrix=function(a){if(null==this.projMatrix){var b=this.zFar,c=this.zNear,d=1/Math.tan(this.node.fieldOfView/2);this.projMatrix=mat4.create([d/a,0,0,0,0,d,0,0,0,0,(c+b)/(c-b),-1,0,0,2*c*b/(c-b),0])}return this.projMatrix};a.getViewMatrix=function(){var a=new window.XML3DMatrix;a._data.set(this.viewMatrix);return a};a.getModelViewMatrix=function(a){return mat4.multiply(this.viewMatrix,a,mat4.create())};
a.getModelViewProjectionMatrix=function(a){return mat4.multiply(this.projMatrix,a,mat4.create())};a.notifyChanged=function(a){var b=a.internalType||a.attrName||a.wrapped.attrName;switch(b){case "parenttransform":this.parentTransform=a.newValue;this.updateViewMatrix();break;case "orientation":case "position":this.updateViewMatrix();break;case "fieldOfView":this.projMatrix=null;break;default:XML3D.debug.logWarning("Unhandled event in view adapter for parameter "+b)}this.factory.handler.redraw("View changed")};
XML3D.webgl.XML3DViewRenderAdapter=b})();(function(){var b=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.renderer=this.factory.renderer;(this.dataAdapter=this.renderer.dataFactory.getAdapter(this.node))?this.dataAdapter.registerObserver(this):XML3D.debug.logError("Data adapter for a shader element could not be created!")};XML3D.createClass(b,XML3D.webgl.RenderAdapter);b.prototype.notifyChanged=function(a){if(0==a.type)this.factory.renderer.sceneTreeAddition(a);else if(2==a.type)this.factory.renderer.sceneTreeRemoval(a);else if(5==
a.type){var b=a.wrapped.target;b&&"texture"==b.nodeName&&this.renderer.recompileShader(this)}else switch(b=a.internalType||a.attrName||a.wrapped.attrName,b){case "script":this.renderer.recompileShader(this);break;case "src":var d=a.wrapped.relatedNode;d.ownerElement&&(d=d.ownerElement);d=d.parentNode;this.renderer.shaderDataChanged(this.node.id,b,a.wrapped.newValue,d.name);break;default:XML3D.debug.logWarning("Unhandled mutation event in shader adapter for parameter '"+b+"'")}};b.prototype.notifyDataChanged=
function(a){if(a.wrapped&&(a=a.wrapped.currentTarget.name||a.wrapped.relatedNode.name)){var b=this.getDataTable()[a].data;2>b.length&&(b=b[0]);this.renderer.shaderDataChanged(this.node.id,a,b)}};b.prototype.getDataTable=function(){return this.dataAdapter.createDataTable()};b.prototype.destroy=function(){Array.forEach(this.textures,function(a){a.adapter.destroy()})};b.prototype.bindSamplers=function(){var a=!1,b;for(b in this.textures){var d=this.textures[b];if(null!=d.adapter.node)d.adapter.bind(d.info.texUnit);
else{a=!0;break}}a&&(delete this.textures[b],this.destroy(),this.enable())};b.prototype.getXFlowShader=function(a,b){if(this.xflowBuilt)return this.program;var d=this.program.vSource,e=this.program.fSource,d=a+d,f=d.indexOf("~"),g=d.substring(0,f+1),d=d.substring(f+3),f={};f.vs=g+"\n"+b+d;f.fs=e;this.xflowBuilt=!0;return this.createShaderProgram(f)};XML3D.webgl.XML3DShaderRenderAdapter=b})();(function(){var b=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.gl=a.renderer.handler.gl;this.factory=a;this.node=b;this.dataAdapter=a.renderer.dataFactory.getAdapter(this.node)};XML3D.createClass(b,XML3D.webgl.RenderAdapter);b.prototype.notifyChanged=function(a){var b=this.factory.getAdapter(this.node.parentElement);b&&b.notifyChanged(a)};b.prototype.getDataTable=function(){return this.dataAdapter.createDataTable()};b.prototype.destroy=function(){this.info&&null!==this.info.handle&&
(this.gl.deleteTexture(this.info.handle),this.info=null,this.bind=function(){},this.unbind=function(){})};b.prototype.dispose=function(){};XML3D.webgl.XML3DTextureRenderAdapter=b})();XML3D.webgl.MAX_MESH_INDEX_COUNT=65535;
(function(){var b=function(){XML3D.debug.logError("Mesh adapter has no callback to its mesh object!")},a=window.WebGLRenderingContext,c=function(a,c){XML3D.webgl.RenderAdapter.call(this,a,c);this.processListeners();this.dataAdapter=a.renderer.dataFactory.getAdapter(this.node);this.dataAdapter.registerObserver(this);this.parentVisible=!0;this.getMyDrawableObject=b};XML3D.createClass(c,XML3D.webgl.RenderAdapter);var d=c.prototype;d.processListeners=function(){var a=this.node.attributes,b;for(b in a){var c=
a[b];if(c.name){var d=c.name;(d.match(/onmouse/)||"onclick"==d||"ondblclick"==d)&&this.node.addEventListener(d.substring(2),new Function("evt",c.value),!1)}}};d.registerCallback=function(a){a instanceof Function&&(this.getMyDrawableObject=a)};d.notifyChanged=function(a){if(0!=a.type){if(2==a.type)return this.factory.renderer.sceneTreeRemoval(a);var b=a.internalType||a.attrName||a.wrapped.attrName;switch(b){case "parenttransform":this.getMyDrawableObject().transform=a.newValue;break;case "parentshader":a=
a.newValue?a.newValue.node.id:"defaultShader";this.getMyDrawableObject().shader=a;break;case "parentvisible":this.getMyDrawableObject().visible=a.newValue&&this.node.visible;break;case "visible":this.getMyDrawableObject().visible="true"==a.wrapped.newValue&&this.node.parentNode.visible;break;case "src":this.dispose(a);a=this.createMesh(this.factory.renderer.getGLContext());this.getMyDrawableObject().mesh=a;break;case "type":a=this.getGLTypeFromString(a.wrapped.newValue);this.getMyDrawableObject().mesh.glType=
a;break;default:XML3D.debug.logWarning("Unhandled mutation event in mesh adapter for parameter '"+b+"'")}}};d.notifyDataChanged=function(){};d.createMesh=function(a){var b=this.dataAdapter.createDataTable();if(!b.position||!b.position.data)return XML3D.debug.logError("Mesh "+this.node.id+" has no data for required attribute 'position'."),{vbos:{},glType:0,valid:!1};var c={vbos:{}},d=this.node.getAttribute("type");c.glType=this.getGLTypeFromString(d);if(b.index)if(b.position.data.length/3>XML3D.webgl.MAX_MESH_INDEX_COUNT&&
XML3D.webgl.splitMesh(b,XML3D.webgl.MAX_MESH_INDEX_COUNT),0<b.index.length){var i=b.index.length;c.vbos.index=[];for(d=0;d<i;d++){var j=new Uint16Array(b.index[d].data),k=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,k);a.bufferData(a.ELEMENT_ARRAY_BUFFER,j,a.STATIC_DRAW);k.length=j.length;k.tupleSize=b.index[d].tupleSize;k.glType=this.getGLTypeFromArray(j);c.vbos.index[d]=k;c.isIndexed=!0}}else j=new Uint16Array(b.index.data),k=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,k),a.bufferData(a.ELEMENT_ARRAY_BUFFER,
j,a.STATIC_DRAW),k.length=j.length,k.tupleSize=b.index.tupleSize,k.glType=this.getGLTypeFromArray(j),c.vbos.index=[],c.vbos.index[0]=k,c.isIndexed=!0;else c.isIndexed=!1;for(var m in b)if(i=b[m],!i.isXflow&&!("xflowShader"==m||"index"==m||"segments"==m))if(0<i.length){j=i.length;c.vbos[m]=[];for(d=0;d<j;d++)k=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,k),a.bufferData(a.ARRAY_BUFFER,i[d].data,a.STATIC_DRAW),k.length=i[d].data.length,k.tupleSize=i[d].tupleSize,k.glType=this.getGLTypeFromArray(i[d].data),
c.vbos[m][d]=k}else k=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,k),a.bufferData(a.ARRAY_BUFFER,i.data,a.STATIC_DRAW),k.length=i.data.length,k.tupleSize=i.tupleSize,k.glType=this.getGLTypeFromArray(i.data),c.vbos[m]=[],c.vbos[m][0]=k;c.valid=!0;c.bbox=XML3D.webgl.calculateBoundingBox(b.position.data,b.index?b.index.data:null);b.size&&(c.segments=b.size);return c};d.applyXFlow=function(a,b){var c=this.dataAdapter.createDataTable();if(c.xflowShader){c=c.xflowShader;a.program=a.getXFlowShader(c.declarations,
c.body);for(var d in c.uniforms){var i=c.uniforms[d].data;2>i.length&&(i=i[0]);b[d]=i}}};d.dispose=function(a){a||(a=this.factory.renderer.getGLContext());var b=this.getMyDrawableObject(),c=b.mesh.vbos,d;for(d in c)for(var i=c[d],j=0;j<i.length;j++)a.deleteBuffer(i[j]);b.mesh.valid=!1};d.destroy=function(a){a||(a=this.factory.renderer.getGLContext());this.getMyDrawableObject!=b&&(this.dispose(a),this.factory.renderer.removeDrawableObject(this.getMyDrawableObject()),this.getMyDrawableObject=b)};d.getBoundingBox=
function(){var a=new window.XML3DBox,b=this.dataAdapter.createDataTable();b&&b.position&&(a=XML3D.webgl.calculateBoundingBox(b.position.data,b.index.data));return a};d.getGLTypeFromString=function(b){b&&b.toLowerCase&&(b=b.toLowerCase());switch(b){case "triangles":return a.TRIANGLES;case "tristrips":return a.TRIANGLE_STRIP;case "points":return a.POINTS;case "lines":return a.LINES;case "linestrips":return a.LINE_STRIP;default:return a.TRIANGLES}};d.getGLTypeFromArray=function(b){return b instanceof
Int8Array?a.BYTE:b instanceof Uint8Array?a.UNSIGNED_BYTE:b instanceof Int16Array?a.SHORT:b instanceof Uint16Array?a.UNSIGNED_SHORT:b instanceof Int32Array?a.INT:b instanceof Uint32Array?a.UNSIGNED_INT:a.FLOAT};XML3D.webgl.XML3DMeshRenderAdapter=c})();(function(){var b=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.processListeners();this.factory=a;this.parentShader=this.parentTransform=null;this.isValid=this.parentVisible=!0;this.updateTransformAdapter()};XML3D.createClass(b,XML3D.webgl.RenderAdapter);var a=b.prototype;a.applyTransformMatrix=function(a){null!==this.parentTransform&&mat4.multiply(this.parentTransform,a,a);this.transformAdapter&&mat4.multiply(a,this.transformAdapter.getMatrix());return a};a.updateTransformAdapter=function(){this.transformAdapter=
null;var a=this.node.transform;if(a&&(a=XML3D.URIResolver.resolve(a)))this.transformAdapter=this.factory.getAdapter(a)};a.processListeners=function(){var a=this.node.attributes,b;for(b in a){var e=a[b];if(e.name){var f=e.name;(f.match(/onmouse/)||"onclick"==f||"ondblclick"==f)&&this.node.addEventListener(f.substring(2),new Function("evt",e.value),!1)}}};a.notifyChanged=function(a){if(0==a.type)this.factory.renderer.sceneTreeAddition(a);else if(2==a.type)this.factory.renderer.sceneTreeRemoval(a);else if(5!=
a.type){var b=a.internalType||a.attrName||a.wrapped.attrName;switch(b){case "shader":b=this.getShader();b||(b=this.parentShader);a.internalType="parentshader";a.newValue=b;this.notifyChildren(a);this.factory.renderer.requestRedraw("Group shader changed.",!1);break;case "parentshader":this.parentShader=null;this.getShader()||this.notifyChildren(a);this.parentShader=a.newValue;break;case "translation":case "rotation":case "scale":b=this.transformAdapter.getMatrix();this.parentTransform&&(b=mat4.multiply(this.parentTransform,
b,mat4.create()));a.internalType="parenttransform";a.newValue=b;this.notifyChildren(a);delete a.internalType;delete a.newValue;break;case "transform":this.updateTransformAdapter(this);b=this.transformAdapter?this.transformAdapter.getMatrix():this.parentTransform?mat4.identity(mat4.create()):null;this.parentTransform&&(b=mat4.multiply(this.parentTransform,b,mat4.create()));a.internalType="parenttransform";a.newValue=b;this.notifyChildren(a);delete a.internalType;delete a.newValue;this.factory.renderer.requestRedraw("Group transform changed.",
!0);break;case "parenttransform":var e=b=a.newValue;this.parentTransform=a.newValue;this.transformAdapter&&(b=mat4.multiply(e,this.transformAdapter.getMatrix(),mat4.create()));a.newValue=b;this.notifyChildren(a);a.newValue=e;break;case "visible":if(!1==this.parentVisible)break;else a.internalType="parentvisible",a.newValue="true"==a.wrapped.newValue,this.notifyChildren(a),delete a.internalType,delete a.newValue,this.factory.renderer.requestRedraw("Group visibility changed.",!0);break;case "parentvisible":this.parentVisible=
a.newValue;if(!1==this.node.visible)break;else this.notifyChildren(a);break;default:XML3D.debug.logWarning("Unhandled mutation event in group adapter for parameter '"+b+"'")}}};a.notifyChildren=function(a){for(var b=this.node.firstElementChild;b;)this.factory.getAdapter(b).notifyChanged(a),b=b.nextElementSibling};a.getShader=function(){var a=this.node.shader;if(""==a){var b=this.node.getAttribute("style");b&&(b=/shader\s*:\s*url\s*\(\s*(\S+)\s*\)/i.exec(b))&&(a=XML3D.URIResolver.resolve(b[1]))}else a=
XML3D.URIResolver.resolve(a);return(a=this.factory.getAdapter(a))||this.parentShader};a.destroy=function(){for(var a=this.node.firstElementChild;a;){var b=this.factory.getAdapter(a);b&&b.destroy&&b.destroy();a=a.nextElementSibling}this.isValid=!1};a.getBoundingBox=function(){var a=new window.XML3DBox;Array.prototype.forEach.call(this.node.childNodes,function(b){b.getBoundingBox&&a.extend(b.getBoundingBox())});this.transformAdapter&&XML3D.webgl.transformAABB(a,this.transformAdapter.getMatrix());return a};
a.getLocalMatrix=function(){var a=new window.XML3DMatrix;null!==this.transformAdapter&&a._data.set(this.transformAdapter.getMatrix());return a};a.getWorldMatrix=function(){var a=new window.XML3DMatrix;this.parentTransform&&a._data.set(this.parentTransform);this.transformAdapter&&mat4.multiply(a._data,this.transformAdapter.getMatrix());return a};XML3D.webgl.XML3DGroupRenderAdapter=b})();(function(){var b=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);var d=b.getAttribute("intensity");if(d)try{this.intensity=parseFloat(d)}catch(e){XML3D.debug.logWarning("Could not parse light intensity attribute ' "+d+" '")}this.visible=!0;this.lightShader=this.transform=this.intensity=this.position=null;this.isValid=!0};XML3D.createClass(b,XML3D.webgl.RenderAdapter);b.prototype.notifyChanged=function(a){switch(a.internalType||a.wrapped.attrName){case "visible":this.visible="true"==a.wrapped.newValue&&
this.node.parentNode.visible;break;case "parentvisible":this.visible=a.newValue&&this.node.visible;break;case "intensity":isNaN(a.newValue)?XML3D.debug.logError("Invalid parameter for light intensity attribute: NaN"):this.intensity=a.newValue;break;case "parenttransform":this.transform=a.newValue}this.factory.handler.redraw("Light attribute changed.")};b.prototype.getParameters=function(a){var b=this.getLightShader();if(!b)return null;a=mat4.create(a);this.transform&&(a=mat4.multiply(a,this.transform,
mat4.create()));if(!this.dataAdapter){var d=b.factory.renderer;(this.dataAdapter=d.dataFactory.getAdapter(b.node))&&this.dataAdapter.registerObserver(d)}var b=this.dataAdapter.createDataTable(),d=this.visible?[1,1,1]:[0,0,0],e=mat4.multiplyVec4(a,quat4.create([0,0,0,1])),d={position:[e[0]/e[3],e[1]/e[3],e[2]/e[3]],attenuation:[0,0,1],intensity:[1,1,1],visibility:d},f;for(f in b)"position"==f?(e=quat4.create([b[f].data[0],b[f].data[1],b[f].data[2],1]),mat4.multiplyVec4(a,e),d[f]=[e[0]/e[3],e[1]/e[3],
e[2]/e[3]]):d[f]=b[f].data;null!==this.intensity&&(f=d.intensity,d.intensity=[f[0]*this.intensity,f[1]*this.intensity,f[2]*this.intensity]);return d};b.prototype.getLightShader=function(){if(!this.lightShader){var a=this.node.shader,b=null;""!=a&&(b=XML3D.URIResolver.resolve(a));if(null==b){a=this.node.getAttribute("style");if(!a)return null;(a=/shader\s*:\s*url\s*\(\s*(\S+)\s*\)/i.exec(a))&&(b=this.node.xml3ddocument.resolve(a[1]))}this.lightShader=this.factory.getAdapter(b)}return this.lightShader};
b.prototype.dispose=function(){this.isValid=!1};XML3D.webgl.XML3DLightRenderAdapter=b})();XML3D.webgl.XML3DDataAdapterFactory=function(b){XML3D.data.AdapterFactory.call(this);this.handler=b};XML3D.webgl.XML3DDataAdapterFactory.prototype=new XML3D.data.AdapterFactory;XML3D.webgl.XML3DDataAdapterFactory.prototype.constructor=XML3D.webgl.XML3DDataAdapterFactory;XML3D.webgl.XML3DDataAdapterFactory.prototype.getAdapter=function(b){return XML3D.data.AdapterFactory.prototype.getAdapter.call(this,b,XML3D.webgl.XML3DDataAdapterFactory.prototype)};
XML3D.webgl.XML3DDataAdapterFactory.prototype.createAdapter=function(b){return"mesh"==b.localName||"shader"==b.localName||"lightshader"==b.localName?new XML3D.webgl.RootDataAdapter(this,b):"float"==b.localName||"float2"==b.localName||"float3"==b.localName||"float4"==b.localName||"float4x4"==b.localName||"int"==b.localName||"bool"==b.localName?new XML3D.webgl.ValueDataAdapter(this,b):"img"==b.localName?new XML3D.webgl.ImgDataAdapter(this,b):"texture"==b.localName?new XML3D.webgl.TextureDataAdapter(this,
b):"data"==b.localName?new XML3D.webgl.DataAdapter(this,b):null};
XML3D.webgl.DataAdapter=function(b,a){XML3D.data.Adapter.call(this,b,a);this.observers=[];this.init=function(){for(var a=this.node.firstElementChild;null!==a;){var b=this.factory.getAdapter(a,XML3D.webgl.XML3DDataAdapterFactory.prototype);b&&b.registerObserver(this);a=a.nextElementSibling}if(this.node.src&&(a=XML3D.URIResolver.resolve(this.node.src)))(b=this.factory.getAdapter(a,XML3D.webgl.XML3DDataAdapterFactory.prototype))&&b.registerObserver(this);this.createDataTable(!0)}};
XML3D.webgl.DataAdapter.prototype=new XML3D.data.Adapter;XML3D.webgl.DataAdapter.prototype.constructor=XML3D.webgl.DataAdapter;XML3D.webgl.DataAdapter.prototype.isAdapterFor=function(b){return b==XML3D.webgl.XML3DDataAdapterFactory.prototype};XML3D.webgl.DataAdapter.prototype.notifyObservers=function(b){for(var a=0;a<this.observers.length;a++)this.observers[a].notifyDataChanged(b)};XML3D.webgl.DataAdapter.prototype.notifyChanged=function(b){this.notifyDataChanged(b)};
XML3D.webgl.DataAdapter.prototype.notifyDataChanged=function(b){this.createDataTable(!0);this.notifyObservers(b)};XML3D.webgl.DataAdapter.prototype.registerObserver=function(b){for(var a=0;a<this.observers.length;a++)if(this.observers[a]==b){XML3D.debug.logWarning("Observer "+b+" is already registered");return}this.observers.push(b)};
XML3D.webgl.DataAdapter.prototype.unregisterObserver=function(b){for(var a=0;a<this.observers.length;a++)if(this.observers[a]==b){this.observers=this.observers.splice(a,1);return}XML3D.debug.logWarning("Observer "+b+" can not be unregistered because it is not registered")};
XML3D.webgl.DataAdapter.prototype.getDataFromChildren=function(){for(var b=[],a=this.node.firstElementChild;null!==a;){var c=this.factory.getAdapter(a,XML3D.webgl.XML3DDataAdapterFactory.prototype);if(c)if(c.isRootAdapter())XML3D.debug.logWarning(a.localName+" can not be a children of another DataCollector element ==> ignored");else{if(c=c.createDataTable())for(var d in c)b[d]=c[d];a=a.nextElementSibling}else a=a.nextElementSibling}return b};
XML3D.webgl.DataAdapter.prototype.createDataTable=function(b){if(void 0==b||!b)return this.dataTable;b=this.node.src;if(""==b)b=this.getDataFromChildren();else{var a=XML3D.URIResolver.resolve(b),a=this.factory.getAdapter(a,XML3D.webgl.XML3DDataAdapterFactory.prototype);if(!a){XML3D.debug.logError("Could not find mesh data with src '"+b+"'");this.dataTable={};return}b=a.createDataTable()}if("data"==this.node.localName&&(a=this.node.script,""!=a)){var c=a.value.toLowerCase();if(XML3D.xflow[c])XML3D.xflow[c](b);
else XML3D.debug.logError("Unknown XFlow script '"+a.value+"'.")}return this.dataTable=b};XML3D.webgl.DataAdapter.prototype.isRootAdapter=function(){return!1};XML3D.webgl.DataAdapter.prototype.toString=function(){return"XML3D.webgl.DataAdapter"};XML3D.webgl.ValueDataAdapter=function(b,a){XML3D.webgl.DataAdapter.call(this,b,a);this.init=function(){this.createDataTable(!0)}};XML3D.webgl.ValueDataAdapter.prototype=new XML3D.webgl.DataAdapter;XML3D.webgl.ValueDataAdapter.prototype.constructor=XML3D.webgl.ValueDataAdapter;
XML3D.webgl.ValueDataAdapter.prototype.getTupleSize=function(){if("float"==this.node.localName||"int"==this.node.localName||"bool"==this.node.localName)return 1;if("float2"==this.node.localName)return 2;if("float3"==this.node.localName)return 3;if("float4"==this.node.localName)return 4;if("float4x4"==this.node.localName)return 16;XML3D.debug.logWarning("Can not determine tuple size of element "+this.node.localName);return-1};
XML3D.webgl.ValueDataAdapter.prototype.extractTextureData=function(b){if("texture"!=b.localName)return null;b=b.firstElementChild;return!b||"img"!=b.localName?(XML3D.debug.logWarning("child of texture element is not an img element"),null):b.src};XML3D.webgl.ValueDataAdapter.prototype.createDataTable=function(b){if(void 0==b||!b)return this.dataTable;var b=this.node.value,a=this.node.name,c=Array(1),d=[];d.tupleSize=this.getTupleSize();d.data=b;c[a]=d;return this.dataTable=c};
XML3D.webgl.ValueDataAdapter.prototype.toString=function(){return"XML3D.webgl.ValueDataAdapter"};XML3D.webgl.RootDataAdapter=function(b,a){XML3D.webgl.DataAdapter.call(this,b,a)};XML3D.webgl.RootDataAdapter.prototype=new XML3D.webgl.DataAdapter;XML3D.webgl.RootDataAdapter.prototype.constructor=XML3D.webgl.RootDataAdapter;XML3D.webgl.RootDataAdapter.prototype.isRootAdapter=function(){return!0};XML3D.webgl.RootDataAdapter.prototype.toString=function(){return"XML3D.webgl.RootDataAdapter"};
XML3D.webgl.ImgDataAdapter=function(b,a){XML3D.webgl.DataAdapter.call(this,b,a);this.init=function(){}};XML3D.webgl.ImgDataAdapter.prototype=new XML3D.webgl.DataAdapter;XML3D.webgl.ImgDataAdapter.prototype.constructor=XML3D.webgl.ImgDataAdapter;XML3D.webgl.ImgDataAdapter.prototype.createDataTable=function(){};XML3D.webgl.TextureDataAdapter=function(b,a){XML3D.webgl.DataAdapter.call(this,b,a)};XML3D.webgl.TextureDataAdapter.prototype=new XML3D.webgl.DataAdapter;
XML3D.webgl.TextureDataAdapter.prototype.constructor=XML3D.webgl.TextureDataAdapter;
XML3D.webgl.TextureDataAdapter.prototype.createDataTable=function(b){if(void 0==b||!b)return this.dataTable;var a=this.factory.handler.gl,c=function(a,b){return"nearest"==b?a.NEAREST:"linear"==b?a.LINEAR:"mipmap_linear"==b?a.LINEAR_MIPMAP_NEAREST:"mipmap_nearest"==b?a.NEAREST_MIPMAP_NEAREST:a.LINEAR},d=this.node,b=[],e={wrapS:"clamp"==d.wrapS?a.CLAMP_TO_EDGE:"repeat"==d.wrapS?a.REPEAT:a.CLAMP_TO_EDGE,wrapT:"clamp"==d.wrapT?a.CLAMP_TO_EDGE:"repeat"==d.wrapT?a.REPEAT:a.CLAMP_TO_EDGE,generateMipmap:!1};
e.minFilter=c(a,d.getAttribute("minFilter"));e.magFilter=c(a,d.getAttribute("magFilter"));"true"==d.getAttribute("mipmap")&&(e.generateMipmap=!0);if(d.hasAttribute("textype")&&"cube"==d.getAttribute("textype")){for(a=0;a<d.childNodes.length;a++)c=d.childNodes[a],"img"==c.localName&&b.push(c.src);if(6!=b.length)return XML3D.debug.logError("A cube map requires 6 textures, but only "+b.length+" were found!"),null;e.flipY=!1}else{d=d.firstElementChild;if(!d||"img"!=d.localName)return XML3D.debug.logWarning("child of texture element is not an img element"),
null;b.push(d.src)}d=Array(1);a=this.node.name;c=[];c.tupleSize=1;c.options=e;c.src=b;c.isTexture=!0;c.node=this.node;d[a]=c;return this.dataTable=d};XML3D.webgl.TextureDataAdapter.prototype.toString=function(){return"XML3D.webgl.TextureDataAdapter"};(function(){var b=function(a,b){XML3D.data.AdapterFactory.call(this);this.handler=a;this.renderer=b;this.name="XML3DRenderAdapterFactory"};XML3D.createClass(b,XML3D.data.AdapterFactory);var a=XML3D.webgl,c={xml3d:a.XML3DCanvasRenderAdapter,view:a.XML3DViewRenderAdapter,defs:a.XML3DDefsRenderAdapter,mesh:a.XML3DMeshRenderAdapter,transform:a.XML3DTransformRenderAdapter,shader:a.XML3DShaderRenderAdapter,texture:a.XML3DTextureRenderAdapter,group:a.XML3DGroupRenderAdapter,img:a.XML3DImgRenderAdapter,light:a.XML3DLightRenderAdapter,
lightshader:a.XML3DLightShaderRenderAdapter};b.prototype.createAdapter=function(a){var b=c[a.localName];return void 0!==b?new b(this,a):null};XML3D.webgl.XML3DRenderAdapterFactory=b})();(function(){var b={},a={};b.register=function(b,d){a[b]=d;d.name=b};b.getScript=function(b){return a[b]};XML3D.shaders=b})();XML3D.shaders.register("matte",{vertex:"attribute vec3 position;\nuniform mat4 modelViewProjectionMatrix;\nvoid main(void) {\n   vec3 pos = position;\n   gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}",fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec3 diffuseColor;\nvoid main(void) {\n    gl_FragColor = vec4(diffuseColor, 1.0);\n}"});XML3D.shaders.register("flat",XML3D.shaders.getScript("matte"));
XML3D.shaders.register("mattevcolor",{vertex:"attribute vec3 position;\nattribute vec3 color;\nvarying vec3 fragVertexColor;\nuniform mat4 modelViewProjectionMatrix;\nvoid main(void) {\n    vec3 pos = position;\n    fragVertexColor = color;\n    gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n}",fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec3 diffuseColor;\nvarying vec3 fragVertexColor;\nvoid main(void) {\n    gl_FragColor = vec4(fragVertexColor, 1.0);\n}"});
XML3D.shaders.register("flatvcolor",XML3D.shaders.getScript("mattevcolor"));XML3D.shaders.register("diffuse",{vertex:"attribute vec3 position;\nattribute vec3 normal;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 eyePosition;\nvoid main(void) {\n    vec3 pos = position;\n    vec3 norm = normal; //~\n    gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n    fragNormal = normalize(normalMatrix * norm);\n    fragVertexPosition = (modelViewMatrix * vec4(pos, 1.0)).xyz;\n    fragEyeVector = normalize(fragVertexPosition);\n}",
fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec3 diffuseColor;\nuniform vec3 emissiveColor;\nuniform float ambientIntensity;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\n#if MAXLIGHTS > 0\nuniform vec3 lightAttenuations[MAXLIGHTS];\nuniform vec3 lightPositions[MAXLIGHTS];\nuniform vec3 lightDiffuseColors[MAXLIGHTS];\nuniform vec3 lightVisibility[MAXLIGHTS];\n#endif\nvoid main(void) {\n  vec3 color = emissiveColor + ambientIntensity * diffuseColor;\n  #if MAXLIGHTS > 0\n      for (int i=0; i<MAXLIGHTS; i++) {\n          vec3 L = lightPositions[i] - fragVertexPosition;\n          vec3 N = fragNormal;\n          float dist = length(L);\n          L = normalize(L);\n          float atten = 1.0 / (lightAttenuations[i].x + lightAttenuations[i].y * dist + lightAttenuations[i].z * dist * dist);\n          vec3 Idiff = lightDiffuseColors[i] * max(dot(N,L),0.0) * diffuseColor ;\n          color = color + (atten*Idiff) * lightVisibility[i];\n      }\n  #endif\n  gl_FragColor = vec4(color, 1.0);\n}"});
XML3D.shaders.register("textureddiffuse",{vertex:"attribute vec2 texcoord;\nattribute vec3 position;\nattribute vec3 normal;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec2 fragTexCoord;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 eyePosition;\nvoid main(void) {\n    vec2 tex = texcoord;\n    vec3 pos = position;\n    vec3 norm = normal; //~\n    gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n    fragNormal = normalize(normalMatrix * norm);\n    fragVertexPosition = (modelViewMatrix * vec4(pos, 1.0)).xyz;\n    fragEyeVector = normalize(fragVertexPosition);\n    fragTexCoord = tex;\n}",
fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec3 diffuseColor;\nuniform sampler2D diffuseTexture;\nuniform vec3 emissiveColor;\nuniform float ambientIntensity;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec2 fragTexCoord;\n#if MAXLIGHTS > 0\nuniform vec3 lightAttenuations[MAXLIGHTS];\nuniform vec3 lightPositions[MAXLIGHTS];\nuniform vec3 lightDiffuseColors[MAXLIGHTS];\nuniform vec3 lightVisibility[MAXLIGHTS];\n#endif\nvoid main(void) {\n  vec4 texDiffuse = texture2D(diffuseTexture, fragTexCoord);\n  vec3 objDiffuse = texDiffuse.xyz * diffuseColor;\n  vec3 color = emissiveColor + ambientIntensity * objDiffuse;\n  #if MAXLIGHTS > 0\n      for (int i=0; i<MAXLIGHTS; i++) {\n          vec3 L = lightPositions[i] - fragVertexPosition;\n          vec3 N = fragNormal;\n          float dist = length(L);\n          L = normalize(L);\n          float atten = 1.0 / (lightAttenuations[i].x + lightAttenuations[i].y * dist + lightAttenuations[i].z * dist * dist);\n          vec3 Idiff = lightDiffuseColors[i] * max(dot(N,L),0.0) * objDiffuse;\n          color = color + (atten*Idiff) * lightVisibility[i];\n      }\n  #endif\n  gl_FragColor = vec4(color, 1.0);\n}"});
XML3D.shaders.register("diffusevcolor",{vertex:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec3 color;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec3 fragVertexColor;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 eyePosition;\nvoid main(void) {\n    vec3 pos = position;\n    vec3 norm = normal; //~\n    gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n    fragNormal = normalize(normalMatrix * norm);\n    fragVertexPosition = (modelViewMatrix * vec4(pos, 1.0)).xyz;\n    fragEyeVector = normalize(fragVertexPosition);\n    fragVertexColor = color;\n}",
fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec3 diffuseColor;\nuniform vec3 emissiveColor;\nuniform float ambientIntensity;\nuniform float transparency;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec3 fragVertexColor;\n#if MAXLIGHTS > 0\nuniform vec3 lightAttenuations[MAXLIGHTS];\nuniform vec3 lightPositions[MAXLIGHTS];\nuniform vec3 lightDiffuseColors[MAXLIGHTS];\nuniform vec3 lightVisibility[MAXLIGHTS];\n#endif\nvoid main(void) {\n  if (transparency > 0.95) discard;\n  vec3 objDiffuse = fragVertexColor * diffuseColor;\n  vec3 color = emissiveColor + ambientIntensity * objDiffuse;\n  #if MAXLIGHTS > 0\n      for (int i=0; i<MAXLIGHTS; i++) {\n          vec3 L = lightPositions[i] - fragVertexPosition;\n          vec3 N = fragNormal;\n          float dist = length(L);\n          L = normalize(L);\n          float atten = 1.0 / (lightAttenuations[i].x + lightAttenuations[i].y * dist + lightAttenuations[i].z * dist * dist);\n          vec3 Idiff = lightDiffuseColors[i] * max(dot(N,L),0.0) * fragVertexColor ;\n          color = color + (atten*Idiff) * lightVisibility[i];\n      }\n  #endif\n  gl_FragColor = vec4(color, 1.0);\n}"});XML3D.shaders.register("phong",{vertex:"attribute vec3 position;\nattribute vec3 normal;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 eyePosition;\nvoid main(void) {\n    vec3 pos = position;\n    vec3 norm = normal; //~\n    gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n    fragNormal = normalize(normalMatrix * norm);\n    fragVertexPosition = (modelViewMatrix * vec4(pos, 1.0)).xyz;\n    fragEyeVector = normalize(fragVertexPosition);\n}",
fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform float ambientIntensity;\nuniform vec3 diffuseColor;\nuniform vec3 emissiveColor;\nuniform float shininess;\nuniform vec3 specularColor;\nuniform float transparency;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\n#if MAXLIGHTS > 0\nuniform vec3 lightAttenuations[MAXLIGHTS];\nuniform vec3 lightPositions[MAXLIGHTS];\nuniform vec3 lightDiffuseColors[MAXLIGHTS];\nuniform vec3 lightVisibility[MAXLIGHTS];\n#endif\nvoid main(void) {\n  if (transparency > 0.95) discard;\n  vec3 color = emissiveColor + ambientIntensity * diffuseColor;\n#if MAXLIGHTS > 0\n  for (int i=0; i<MAXLIGHTS; i++) {\n    vec3 L = lightPositions[i] - fragVertexPosition;\n    vec3 N = fragNormal;\n    vec3 E = fragEyeVector;\n    float dist = length(L);\n    L = normalize(L);\n    vec3 R = normalize(reflect(L,N));\n    float atten = 1.0 / (lightAttenuations[i].x + lightAttenuations[i].y * dist + lightAttenuations[i].z * dist * dist);\n    vec3 Idiff = lightDiffuseColors[i] * max(dot(N,L),0.0) * diffuseColor ;\n    vec3 Ispec = specularColor * pow(max(dot(R,E),0.0), shininess*128.0) * lightDiffuseColors[i];\n    color = color + (atten*(Idiff + Ispec)) * lightVisibility[i];\n  }\n#endif\n  gl_FragColor = vec4(color, max(0.0, 1.0 - transparency));\n}"});
XML3D.shaders.register("texturedphong",{vertex:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texcoord;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec2 fragTexCoord;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 eyePosition;\nvoid main(void) {\n    vec2 tex = texcoord;\n    vec3 pos = position;\n    vec3 norm = normal;\n    gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n    fragNormal = normalize(normalMatrix * norm);\n    fragVertexPosition = (modelViewMatrix * vec4(pos, 1.0)).xyz;\n    fragEyeVector = normalize(fragVertexPosition);\n    fragTexCoord = tex;\n}",
fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform float ambientIntensity;\nuniform vec3 diffuseColor;\nuniform vec3 emissiveColor;\nuniform float shininess;\nuniform vec3 specularColor;\nuniform float transparency;\nuniform float lightOn;\nuniform sampler2D diffuseTexture;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec2 fragTexCoord;\n#if MAXLIGHTS > 0\nuniform vec3 lightAttenuations[MAXLIGHTS];\nuniform vec3 lightPositions[MAXLIGHTS];\nuniform vec3 lightDiffuseColors[MAXLIGHTS];\nuniform vec3 lightVisibility[MAXLIGHTS];\n#endif\nvoid main(void) {\n  vec4 texDiffuse = texture2D(diffuseTexture, fragTexCoord);\n  vec3 objDiffuse = texDiffuse.xyz * diffuseColor;\n  vec4 color = vec4(emissiveColor + ambientIntensity * objDiffuse, 0.0);\n#if MAXLIGHTS > 0\n      for (int i=0; i<MAXLIGHTS; i++) {\n          vec3 L = lightPositions[i] - fragVertexPosition;\n          vec3 N = fragNormal;\n          vec3 E = fragEyeVector;\n          float dist = length(L);\n          L = normalize(L);\n          vec3 R = normalize(reflect(L,N));\n          float atten = 1.0 / (lightAttenuations[i].x + lightAttenuations[i].y * dist + lightAttenuations[i].z * dist * dist);\n          vec3 Idiff = lightDiffuseColors[i] * max(dot(N,L),0.0) * objDiffuse;\n          vec3 Ispec = specularColor * pow(max(dot(R,E),0.0), shininess*128.0) * lightDiffuseColors[i];\n          color += vec4((atten*(Idiff + Ispec))*lightVisibility[i], 0.0);\n      }\n#endif\n  float alpha = texDiffuse.w * max(0.0, 1.0 - transparency);\n  if (alpha < 0.1) discard;\n  gl_FragColor = vec4(color.xyz, alpha);\n}"});
XML3D.shaders.register("phongvcolor",{vertex:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec3 color;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec3 fragVertexColor;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 eyePosition;\nvoid main(void) {\n    vec3 pos = position;\n    vec3 norm = normal; //~\n    gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n    fragNormal = normalize(normalMatrix * norm);\n    fragVertexPosition = (modelViewMatrix * vec4(pos, 1.0)).xyz;\n    fragEyeVector = normalize(fragVertexPosition);\n    fragVertexColor = color;\n}",
fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform float ambientIntensity;\nuniform vec3 diffuseColor;\nuniform vec3 emissiveColor;\nuniform float shininess;\nuniform vec3 specularColor;\nuniform float transparency;\nuniform float lightOn;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec3 fragVertexColor;\n#if MAXLIGHTS > 0\nuniform vec3 lightAttenuations[MAXLIGHTS];\nuniform vec3 lightPositions[MAXLIGHTS];\nuniform vec3 lightDiffuseColors[MAXLIGHTS];\nuniform vec3 lightVisibility[MAXLIGHTS];\n#endif\nvoid main(void) {\n  if (transparency > 0.95) discard;\n  vec3 objDiffuse = fragVertexColor * diffuseColor;\n  vec3 color = emissiveColor + ambientIntensity * objDiffuse;\n#if MAXLIGHTS > 0\n      for (int i=0; i<MAXLIGHTS; i++) {\n          vec3 L = lightPositions[i] - fragVertexPosition;\n          vec3 N = fragNormal;\n          vec3 E = fragEyeVector;\n          float dist = length(L);\n          L = normalize(L);\n          vec3 R = normalize(reflect(L,N));\n          float atten = 1.0 / (lightAttenuations[i].x + lightAttenuations[i].y * dist + lightAttenuations[i].z * dist * dist);\n          vec3 Idiff = lightDiffuseColors[i] * max(dot(N,L),0.0) * objDiffuse;\n          vec3 Ispec = specularColor * pow(max(dot(R,E),0.0), shininess*128.0) * lightDiffuseColors[i];\n          color += (atten*(Idiff + Ispec))*lightVisibility[i];\n      }\n#endif\n  gl_FragColor = vec4(color, max(0.0, 1.0 - transparency));\n}"});XML3D.shaders.register("picking",{vertex:"attribute vec3 position;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform vec3 min;\nuniform vec3 max;\nvarying vec3 worldCoord;\nvoid main(void) {\n    worldCoord = (modelMatrix * vec4(position, 1.0)).xyz;\n    vec3 diff = max - min;\n    worldCoord = worldCoord - min;\n    worldCoord = worldCoord / diff;\n    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}",fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform float id;\nvarying vec3 worldCoord;\nvoid main(void) {\n    gl_FragColor = vec4(worldCoord, id);\n}"});
XML3D.shaders.register("pickedNormals",{vertex:"attribute vec3 position;\nattribute vec3 normal;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat3 normalMatrix;\nvarying vec3 fragNormal;\nvoid main(void) {\n    fragNormal = normalize(normalMatrix * normal);\n    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}",fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nvarying vec3 fragNormal;\nvoid main(void) {\n    gl_FragColor = vec4((fragNormal+1.0)/2.0, 1.0);\n}"});